2025-07-04 03:06:19,349 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:06:19,349 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:06:26,607 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCHF, Type: BUY
2025-07-04 03:06:49,212 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCHF, Type: BUY
2025-07-04 03:09:51,346 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:09:51,346 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:09:55,476 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:09:55,476 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:09:57,412 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCHF, Type: BUY
2025-07-04 03:09:57,781 - INFO - orders - [MARGIN_CALC] Market data for AUDCHF: {'b': '0.5205000000', 'o': '0.5204700000'}
2025-07-04 03:09:57,781 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCHF, using bid price with spread: bid=0.5205000000, ask=0.52055205000000
2025-07-04 03:09:57,781 - INFO - orders - [MARGIN_CALC] Using prices for AUDCHF: bid=0.5205000000, ask=0.52055205000000
2025-07-04 03:09:57,782 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.21 CHF to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 03:09:57,782 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-04 03:09:57,783 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:09:57,783 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-04 03:09:57,783 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-04 03:09:57,784 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7935200000'), 'o': Decimal('0.7934800000')}
2025-07-04 03:09:57,784 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7935200000
2025-07-04 03:09:57,784 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.21 CHF / 0.7935200000 = 6.565682024397620727895957254 USD
2025-07-04 03:09:57,784 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCHF, Type: BUY, Qty: 0.01, Price: 0.52055205000000, Margin: 6.565682024397620727895957254, Commission: 0.10
2025-07-04 03:09:57,785 - INFO - orders - [PERF] Order processing: 0.3605s
2025-07-04 03:09:57,785 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '3101929268', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_price': Decimal('0.52055205000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('520.55'), 'margin': Decimal('6.565682024397620727895957254'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:09:57,785 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 3101929268
2025-07-04 03:09:57,805 - INFO - orders - [PERF] Order creation: 0.0207s
2025-07-04 03:09:57,805 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 03:09:57,806 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 03:09:57,806 - INFO - orders - Publishing order update for user 4
2025-07-04 03:09:57,807 - INFO - orders - Publishing user data update for user 4
2025-07-04 03:09:57,807 - INFO - orders - Publishing market data trigger
2025-07-04 03:09:57,808 - INFO - orders - [PERF] TOTAL place_order: 0.3962s
2025-07-04 03:09:57,822 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:09:57,827 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:09:57,828 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 03:09:57,829 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '3101929268', 'user_id': 4, 'symbol': 'AUDCHF', 'order_type': 'BUY', 'quantity': 0.01, 'price': 0.52055205, 'status': 'OPEN', 'contract_value': 520.55}
2025-07-04 03:10:06,833 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCHF, Type: BUY
2025-07-04 03:10:07,243 - INFO - orders - [MARGIN_CALC] Market data for AUDCHF: {'b': '0.5205200000', 'o': '0.5204700000'}
2025-07-04 03:10:07,243 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCHF, using bid price with spread: bid=0.5205200000, ask=0.52057205200000
2025-07-04 03:10:07,243 - INFO - orders - [MARGIN_CALC] Using prices for AUDCHF: bid=0.5205200000, ask=0.52057205200000
2025-07-04 03:10:07,250 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.21 CHF to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 03:10:07,250 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-04 03:10:07,257 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:10:07,257 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-04 03:10:07,257 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-04 03:10:07,260 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7935500000'), 'o': Decimal('0.7935200000')}
2025-07-04 03:10:07,260 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7935500000
2025-07-04 03:10:07,260 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.21 CHF / 0.7935500000 = 6.565433810093881923004221536 USD
2025-07-04 03:10:07,260 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCHF, Type: BUY, Qty: 0.01, Price: 0.52057205200000, Margin: 6.565433810093881923004221536, Commission: 0.10
2025-07-04 03:10:07,265 - INFO - orders - [PERF] Order processing: 0.4290s
2025-07-04 03:10:07,265 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '8916222505', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_price': Decimal('0.52057205200000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('520.57'), 'margin': Decimal('6.565433810093881923004221536'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:10:07,266 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 8916222505
2025-07-04 03:10:07,301 - INFO - orders - [PERF] Order creation: 0.0354s
2025-07-04 03:10:07,301 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 03:10:07,301 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 03:10:07,301 - INFO - orders - Publishing order update for user 4
2025-07-04 03:10:07,306 - INFO - orders - Publishing user data update for user 4
2025-07-04 03:10:07,311 - INFO - orders - Publishing market data trigger
2025-07-04 03:10:07,314 - INFO - orders - [PERF] TOTAL place_order: 0.4823s
2025-07-04 03:10:07,389 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:10:07,398 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:10:07,403 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 03:10:07,406 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '8916222505', 'user_id': 4, 'symbol': 'AUDCHF', 'order_type': 'BUY', 'quantity': 0.01, 'price': 0.520572052, 'status': 'OPEN', 'contract_value': 520.57}
2025-07-04 03:10:13,542 - INFO - orders - Order close request received - Order ID: 3649865209, User ID: 4, Close Price: 0.52037
2025-07-04 03:10:13,543 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000002800B307750>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:10:13,543 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-04 03:10:13,543 - INFO - orders - Request to close order 3649865209 for user 4 (user_type: live) with price 0.52037. Frontend provided type: BUY, company: AUDCHF, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:10:13,546 - INFO - orders - User group: Standard, sending_orders setting: barclays
2025-07-04 03:10:13,546 - INFO - orders - Live user 4 from group 'Standard' has 'sending_orders' set to 'barclays'. Pushing close request to Firebase and skipping local DB update.
2025-07-04 03:10:13,547 - INFO - orders - [FIREBASE_CLOSE_REQUEST] Preparing to send payload for user-initiated close: {'order_id': '3649865209', 'close_price': '0.52037', 'user_id': 4, 'order_type': 'BUY', 'order_company_name': 'AUDCHF', 'order_quantity': '0.01000000', 'contract_value': '520.31000000', 'order_status': 'CLOSED', 'status': 'CLOSED', 'action': 'close_order', 'close_id': '3376757372'}
2025-07-04 03:10:14,086 - INFO - orders - Order close request received - Order ID: 7660709467, User ID: 4, Close Price: 0.89158
2025-07-04 03:10:14,086 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000002800B307C50>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:10:14,087 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-04 03:10:14,087 - INFO - orders - Request to close order 7660709467 for user 4 (user_type: live) with price 0.89158. Frontend provided type: SELL, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:10:14,089 - INFO - orders - User group: Standard, sending_orders setting: barclays
2025-07-04 03:10:14,089 - INFO - orders - Live user 4 from group 'Standard' has 'sending_orders' set to 'barclays'. Pushing close request to Firebase and skipping local DB update.
2025-07-04 03:10:14,090 - INFO - orders - [FIREBASE_CLOSE_REQUEST] Preparing to send payload for user-initiated close: {'order_id': '7660709467', 'close_price': '0.89158', 'user_id': 4, 'order_type': 'SELL', 'order_company_name': 'AUDCAD', 'order_quantity': '0.01000000', 'contract_value': '891.31000000', 'order_status': 'CLOSED', 'status': 'CLOSED', 'action': 'close_order', 'close_id': '1550095022'}
2025-07-04 03:10:14,859 - INFO - orders - Order close request received - Order ID: 9836469641, User ID: 4, Close Price: 0.89131
2025-07-04 03:10:14,859 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000002800B307750>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:10:14,859 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-04 03:10:14,859 - INFO - orders - Request to close order 9836469641 for user 4 (user_type: live) with price 0.89131. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:10:14,876 - INFO - orders - User group: Standard, sending_orders setting: barclays
2025-07-04 03:10:14,876 - INFO - orders - Live user 4 from group 'Standard' has 'sending_orders' set to 'barclays'. Pushing close request to Firebase and skipping local DB update.
2025-07-04 03:10:14,879 - INFO - orders - [FIREBASE_CLOSE_REQUEST] Preparing to send payload for user-initiated close: {'order_id': '9836469641', 'close_price': '0.89131', 'user_id': 4, 'order_type': 'BUY', 'order_company_name': 'AUDCAD', 'order_quantity': '0.01000000', 'contract_value': '891.40000000', 'order_status': 'CLOSED', 'status': 'CLOSED', 'action': 'close_order', 'close_id': '2797501321'}
2025-07-04 03:10:15,428 - INFO - orders - Order close request received - Order ID: 5338478143, User ID: 4, Close Price: 0.89133
2025-07-04 03:10:15,428 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000002800B306490>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:10:15,428 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-04 03:10:15,428 - INFO - orders - Request to close order 5338478143 for user 4 (user_type: live) with price 0.89133. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:10:15,430 - INFO - orders - User group: Standard, sending_orders setting: barclays
2025-07-04 03:10:15,430 - INFO - orders - Live user 4 from group 'Standard' has 'sending_orders' set to 'barclays'. Pushing close request to Firebase and skipping local DB update.
2025-07-04 03:10:15,431 - INFO - orders - [FIREBASE_CLOSE_REQUEST] Preparing to send payload for user-initiated close: {'order_id': '5338478143', 'close_price': '0.89133', 'user_id': 4, 'order_type': 'BUY', 'order_company_name': 'AUDCAD', 'order_quantity': '0.01000000', 'contract_value': '891.41000000', 'order_status': 'CLOSED', 'status': 'CLOSED', 'action': 'close_order', 'close_id': '3408824136'}
2025-07-04 03:10:15,972 - INFO - orders - Order close request received - Order ID: 6253049859, User ID: 4, Close Price: 0.89158
2025-07-04 03:10:15,972 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000002800B307750>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:10:15,972 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-04 03:10:15,972 - INFO - orders - Request to close order 6253049859 for user 4 (user_type: live) with price 0.89158. Frontend provided type: SELL, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:10:15,977 - INFO - orders - User group: Standard, sending_orders setting: barclays
2025-07-04 03:10:15,977 - INFO - orders - Live user 4 from group 'Standard' has 'sending_orders' set to 'barclays'. Pushing close request to Firebase and skipping local DB update.
2025-07-04 03:10:15,979 - INFO - orders - [FIREBASE_CLOSE_REQUEST] Preparing to send payload for user-initiated close: {'order_id': '6253049859', 'close_price': '0.89158', 'user_id': 4, 'order_type': 'SELL', 'order_company_name': 'AUDCAD', 'order_quantity': '0.01000000', 'contract_value': '891.22000000', 'order_status': 'CLOSED', 'status': 'CLOSED', 'action': 'close_order', 'close_id': '9498801186'}
2025-07-04 03:10:16,550 - INFO - orders - Order close request received - Order ID: 5239114834, User ID: 4, Close Price: 0.89133
2025-07-04 03:10:16,550 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000002800B307C50>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:10:16,550 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-04 03:10:16,550 - INFO - orders - Request to close order 5239114834 for user 4 (user_type: live) with price 0.89133. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:10:16,555 - INFO - orders - User group: Standard, sending_orders setting: barclays
2025-07-04 03:10:16,555 - INFO - orders - Live user 4 from group 'Standard' has 'sending_orders' set to 'barclays'. Pushing close request to Firebase and skipping local DB update.
2025-07-04 03:10:16,556 - INFO - orders - [FIREBASE_CLOSE_REQUEST] Preparing to send payload for user-initiated close: {'order_id': '5239114834', 'close_price': '0.89133', 'user_id': 4, 'order_type': 'BUY', 'order_company_name': 'AUDCAD', 'order_quantity': '0.01000000', 'contract_value': '891.32000000', 'order_status': 'CLOSED', 'status': 'CLOSED', 'action': 'close_order', 'close_id': '2243829083'}
2025-07-04 03:10:49,313 - INFO - orders - Add stoploss request received - Order ID: 3649865209, User ID: 4
2025-07-04 03:10:49,319 - INFO - orders - Generated stoploss_id: 4103632827 for order 3649865209
2025-07-04 03:10:49,320 - INFO - orders - User 4 is_barclays_live_user: True
2025-07-04 03:10:49,320 - INFO - orders - Barclays user detected. Sending stoploss request to Firebase for order 3649865209
2025-07-04 03:10:49,614 - INFO - orders - Stoploss request sent to Firebase for order 3649865209
2025-07-04 03:10:58,286 - INFO - orders - Add takeprofit request received - Order ID: 3649865209, User ID: 4
2025-07-04 03:10:58,294 - INFO - orders - Generated takeprofit_id: 2556910970 for order 3649865209
2025-07-04 03:10:58,296 - INFO - orders - User 4 is_barclays_live_user: True
2025-07-04 03:10:58,297 - INFO - orders - Barclays user detected. Sending takeprofit request to Firebase for order 3649865209
2025-07-04 03:10:58,611 - INFO - orders - Takeprofit request sent to Firebase for order 3649865209
2025-07-04 03:13:00,322 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:13:00,322 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:13:30,807 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-07-04 03:13:41,593 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCAD, Type: BUY
2025-07-04 03:13:41,912 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8915400000', 'o': '0.8914800000'}
2025-07-04 03:13:41,913 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8915400000, ask=0.89162915400000
2025-07-04 03:13:41,913 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8915400000, ask=0.89162915400000
2025-07-04 03:13:41,915 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 03:13:41,915 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:13:41,916 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:13:41,917 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:13:41,917 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:13:41,919 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3590800000'), 'o': Decimal('1.3590700000')}
2025-07-04 03:13:41,919 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3590800000
2025-07-04 03:13:41,919 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3590800000 = 6.563263384053918827442093181 USD
2025-07-04 03:13:41,920 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89162915400000, Margin: 6.563263384053918827442093181, Commission: 0.10
2025-07-04 03:13:41,947 - INFO - orders - [PERF] Order processing: 0.3393s
2025-07-04 03:13:41,948 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '6631311810', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89162915400000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.63'), 'margin': Decimal('6.563263384053918827442093181'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:13:41,948 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 6631311810
2025-07-04 03:13:41,975 - INFO - orders - [PERF] Order creation: 0.0270s
2025-07-04 03:13:41,975 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 03:13:41,975 - INFO - orders - Publishing order update for user 1
2025-07-04 03:13:41,976 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:13:41,978 - INFO - orders - Publishing market data trigger
2025-07-04 03:13:41,981 - INFO - orders - [PERF] TOTAL place_order: 0.3880s
2025-07-04 03:13:42,013 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 2 open orders, 0 pending orders
2025-07-04 03:13:42,024 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:13:44,093 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCAD, Type: SELL
2025-07-04 03:13:44,398 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8915300000', 'o': '0.8914700000'}
2025-07-04 03:13:44,398 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8915300000, ask=0.89161915300000
2025-07-04 03:13:44,398 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8915300000, ask=0.89161915300000
2025-07-04 03:13:44,400 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 03:13:44,400 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:13:44,401 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:13:44,401 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:13:44,401 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:13:44,402 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3590900000'), 'o': Decimal('1.3590800000')}
2025-07-04 03:13:44,402 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3590900000
2025-07-04 03:13:44,402 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3590900000 = 6.563215092451566857235356010 USD
2025-07-04 03:13:44,402 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: SELL, Qty: 0.01, Price: 0.8915300000, Margin: 6.563215092451566857235356010, Commission: 0.10
2025-07-04 03:13:44,414 - INFO - orders - [PERF] Order processing: 0.3190s
2025-07-04 03:13:44,414 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '5398391388', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'SELL', 'order_price': Decimal('0.8915300000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.53'), 'margin': Decimal('6.563215092451566857235356010'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:13:44,415 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 5398391388
2025-07-04 03:13:44,429 - INFO - orders - [PERF] Order creation: 0.0148s
2025-07-04 03:13:44,429 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 03:13:44,429 - INFO - orders - Publishing order update for user 1
2025-07-04 03:13:44,430 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:13:44,432 - INFO - orders - Publishing market data trigger
2025-07-04 03:13:44,434 - INFO - orders - [PERF] TOTAL place_order: 0.3415s
2025-07-04 03:13:44,474 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 3 open orders, 0 pending orders
2025-07-04 03:13:44,483 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:13:46,025 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCAD, Type: SELL
2025-07-04 03:13:46,333 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8915400000', 'o': '0.8914700000'}
2025-07-04 03:13:46,333 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8915400000, ask=0.89162915400000
2025-07-04 03:13:46,333 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8915400000, ask=0.89162915400000
2025-07-04 03:13:46,337 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 03:13:46,337 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:13:46,338 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:13:46,340 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:13:46,340 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:13:46,341 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3590900000'), 'o': Decimal('1.3590800000')}
2025-07-04 03:13:46,341 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3590900000
2025-07-04 03:13:46,341 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3590900000 = 6.563215092451566857235356010 USD
2025-07-04 03:13:46,341 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: SELL, Qty: 0.01, Price: 0.8915400000, Margin: 6.563215092451566857235356010, Commission: 0.10
2025-07-04 03:13:46,365 - INFO - orders - [PERF] Order processing: 0.3352s
2025-07-04 03:13:46,365 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '1183435783', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'SELL', 'order_price': Decimal('0.8915400000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.54'), 'margin': Decimal('6.563215092451566857235356010'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:13:46,366 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 1183435783
2025-07-04 03:13:46,388 - INFO - orders - [PERF] Order creation: 0.0224s
2025-07-04 03:13:46,389 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 03:13:46,390 - INFO - orders - Publishing order update for user 1
2025-07-04 03:13:46,391 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:13:46,393 - INFO - orders - Publishing market data trigger
2025-07-04 03:13:46,395 - INFO - orders - [PERF] TOTAL place_order: 0.3700s
2025-07-04 03:13:46,434 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 4 open orders, 0 pending orders
2025-07-04 03:13:46,443 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:13:50,855 - INFO - orders - Order close request received - Order ID: 1183435783, User ID: 1, Close Price: 0.8915
2025-07-04 03:13:50,855 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x00000251924A16E0>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:13:50,855 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-04 03:13:50,856 - INFO - orders - Request to close order 1183435783 for user 1 (user_type: demo) with price 0.8915. Frontend provided type: SELL, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:13:50,869 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-04 03:13:50,881 - INFO - orders - Existing entry commission for order 1183435783: 0.10000000
2025-07-04 03:13:50,881 - INFO - orders - Commission calculation for order 1183435783: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-04 03:13:50,881 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 0.040000000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 1183435783)
2025-07-04 03:13:50,881 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:13:50,882 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:13:50,882 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:13:50,882 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:13:50,883 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3590900000'), 'o': Decimal('1.3590800000')}
2025-07-04 03:13:50,883 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3590900000
2025-07-04 03:13:50,883 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 0.040000000000000000000000 CAD / 1.3590900000 = 0.02943145781368415631047244848 USD
2025-07-04 03:13:50,914 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24972.12000000, margin=19.67
2025-07-04 03:13:50,914 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24972.12000000, margin=19.67
2025-07-04 03:13:50,916 - INFO - orders - User data cache updated for user 1
2025-07-04 03:13:50,916 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-04 03:13:50,916 - INFO - orders - Using order model: DemoUserOrder
2025-07-04 03:13:50,920 - INFO - orders - Fetched 3 open orders for user 1
2025-07-04 03:13:50,922 - INFO - orders - Fetched 0 pending orders for user 1
2025-07-04 03:13:50,924 - INFO - orders - Updated static orders cache for user 1 with 3 open orders and 0 pending orders
2025-07-04 03:13:50,924 - INFO - orders - Publishing order update for user 1
2025-07-04 03:13:50,925 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:13:50,927 - INFO - orders - Publishing market data trigger
2025-07-04 03:13:51,464 - INFO - orders - Order close request received - Order ID: 5398391388, User ID: 1, Close Price: 0.8915
2025-07-04 03:13:51,465 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x00000251924A0B00>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:13:51,465 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-04 03:13:51,465 - INFO - orders - Request to close order 5398391388 for user 1 (user_type: demo) with price 0.8915. Frontend provided type: SELL, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:13:51,478 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-04 03:13:51,495 - INFO - orders - Existing entry commission for order 5398391388: 0.10000000
2025-07-04 03:13:51,495 - INFO - orders - Commission calculation for order 5398391388: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-04 03:13:51,495 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 0.030000000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 5398391388)
2025-07-04 03:13:51,495 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:13:51,496 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:13:51,496 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:13:51,496 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:13:51,496 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3590900000'), 'o': Decimal('1.3590800000')}
2025-07-04 03:13:51,497 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3590900000
2025-07-04 03:13:51,497 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 0.030000000000000000000000 CAD / 1.3590900000 = 0.02207359336026311723285433636 USD
2025-07-04 03:13:51,525 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24971.94000000, margin=19.67
2025-07-04 03:13:51,525 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24971.94000000, margin=19.67
2025-07-04 03:13:51,526 - INFO - orders - User data cache updated for user 1
2025-07-04 03:13:51,527 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-04 03:13:51,527 - INFO - orders - Using order model: DemoUserOrder
2025-07-04 03:13:51,530 - INFO - orders - Fetched 2 open orders for user 1
2025-07-04 03:13:51,533 - INFO - orders - Fetched 0 pending orders for user 1
2025-07-04 03:13:51,534 - INFO - orders - Updated static orders cache for user 1 with 2 open orders and 0 pending orders
2025-07-04 03:13:51,534 - INFO - orders - Publishing order update for user 1
2025-07-04 03:13:51,535 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:13:51,537 - INFO - orders - Publishing market data trigger
2025-07-04 03:13:52,077 - INFO - orders - Order close request received - Order ID: 6631311810, User ID: 1, Close Price: 0.89146
2025-07-04 03:13:52,077 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x00000251924A02B0>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:13:52,078 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-04 03:13:52,078 - INFO - orders - Request to close order 6631311810 for user 1 (user_type: demo) with price 0.89146. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:13:52,093 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-04 03:13:52,117 - INFO - orders - Existing entry commission for order 6631311810: 0.10000000
2025-07-04 03:13:52,117 - INFO - orders - Commission calculation for order 6631311810: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-04 03:13:52,118 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.169150000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 6631311810)
2025-07-04 03:13:52,118 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:13:52,119 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:13:52,119 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:13:52,119 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:13:52,121 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3590900000'), 'o': Decimal('1.3590800000')}
2025-07-04 03:13:52,121 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3590900000
2025-07-04 03:13:52,121 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.169150000000000000000000 CAD / 1.3590900000 = -0.1244582772296168759979103665 USD
2025-07-04 03:13:52,143 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24971.62000000, margin=13.11
2025-07-04 03:13:52,143 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24971.62000000, margin=13.11
2025-07-04 03:13:52,145 - INFO - orders - User data cache updated for user 1
2025-07-04 03:13:52,145 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-04 03:13:52,145 - INFO - orders - Using order model: DemoUserOrder
2025-07-04 03:13:52,148 - INFO - orders - Fetched 1 open orders for user 1
2025-07-04 03:13:52,152 - INFO - orders - Fetched 0 pending orders for user 1
2025-07-04 03:13:52,153 - INFO - orders - Updated static orders cache for user 1 with 1 open orders and 0 pending orders
2025-07-04 03:13:52,153 - INFO - orders - Publishing order update for user 1
2025-07-04 03:13:52,154 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:13:52,156 - INFO - orders - Publishing market data trigger
2025-07-04 03:13:52,696 - INFO - orders - Order close request received - Order ID: 1021678564, User ID: 1, Close Price: 0.52028
2025-07-04 03:13:52,696 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x00000251924A1810>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:13:52,696 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-04 03:13:52,696 - INFO - orders - Request to close order 1021678564 for user 1 (user_type: demo) with price 0.52028. Frontend provided type: BUY, company: AUDCHF, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:13:52,711 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-04 03:13:52,735 - INFO - orders - Existing entry commission for order 1021678564: 0.10000000
2025-07-04 03:13:52,735 - INFO - orders - Commission calculation for order 1021678564: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-04 03:13:52,735 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.002020000000000000000000 CHF to USD for PnL on Close (user_id: 1, position: 1021678564)
2025-07-04 03:13:52,735 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-04 03:13:52,737 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:13:52,737 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-04 03:13:52,737 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-04 03:13:52,740 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7935500000'), 'o': Decimal('0.7935100000')}
2025-07-04 03:13:52,740 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7935500000
2025-07-04 03:13:52,740 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.002020000000000000000000 CHF / 0.7935500000 = -0.002545523281456745006615840212 USD
2025-07-04 03:13:53,068 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24971.42000000, margin=6.56
2025-07-04 03:13:53,068 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24971.42000000, margin=6.56
2025-07-04 03:13:53,069 - INFO - orders - User data cache updated for user 1
2025-07-04 03:13:53,070 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-04 03:13:53,070 - INFO - orders - Using order model: DemoUserOrder
2025-07-04 03:13:53,073 - INFO - orders - Fetched 0 open orders for user 1
2025-07-04 03:13:53,076 - INFO - orders - Fetched 0 pending orders for user 1
2025-07-04 03:13:53,077 - INFO - orders - Updated static orders cache for user 1 with 0 open orders and 0 pending orders
2025-07-04 03:13:53,077 - INFO - orders - Publishing order update for user 1
2025-07-04 03:13:53,078 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:13:53,080 - INFO - orders - Publishing market data trigger
2025-07-04 03:14:21,027 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCAD, Type: BUY
2025-07-04 03:14:21,439 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8915400000', 'o': '0.8914800000'}
2025-07-04 03:14:21,440 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8915400000, ask=0.89162915400000
2025-07-04 03:14:21,440 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8915400000, ask=0.89162915400000
2025-07-04 03:14:21,442 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 03:14:21,442 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:14:21,444 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:14:21,445 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:14:21,445 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:14:21,448 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3590900000'), 'o': Decimal('1.3590600000')}
2025-07-04 03:14:21,448 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3590900000
2025-07-04 03:14:21,448 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3590900000 = 6.563215092451566857235356010 USD
2025-07-04 03:14:21,448 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89162915400000, Margin: 6.563215092451566857235356010, Commission: 0.10
2025-07-04 03:14:21,474 - INFO - orders - [PERF] Order processing: 0.4447s
2025-07-04 03:14:21,474 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '2755759095', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89162915400000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.63'), 'margin': Decimal('6.563215092451566857235356010'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:14:21,475 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 2755759095
2025-07-04 03:14:21,494 - INFO - orders - [PERF] Order creation: 0.0196s
2025-07-04 03:14:21,494 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 03:14:21,494 - INFO - orders - Publishing order update for user 1
2025-07-04 03:14:21,496 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:14:21,499 - INFO - orders - Publishing market data trigger
2025-07-04 03:14:21,501 - INFO - orders - [PERF] TOTAL place_order: 0.4736s
2025-07-04 03:14:21,530 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 1 open orders, 0 pending orders
2025-07-04 03:14:21,541 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:14:23,326 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCAD, Type: SELL
2025-07-04 03:14:23,627 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8915400000', 'o': '0.8914800000'}
2025-07-04 03:14:23,627 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8915400000, ask=0.89162915400000
2025-07-04 03:14:23,627 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8915400000, ask=0.89162915400000
2025-07-04 03:14:23,628 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 03:14:23,629 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:14:23,632 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:14:23,632 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:14:23,633 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:14:23,637 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3591000000'), 'o': Decimal('1.3590600000')}
2025-07-04 03:14:23,637 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3591000000
2025-07-04 03:14:23,637 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3591000000 = 6.563166801559855786917813259 USD
2025-07-04 03:14:23,637 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: SELL, Qty: 0.01, Price: 0.8915400000, Margin: 6.563166801559855786917813259, Commission: 0.10
2025-07-04 03:14:23,652 - INFO - orders - [PERF] Order processing: 0.3224s
2025-07-04 03:14:23,652 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '9272386308', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'SELL', 'order_price': Decimal('0.8915400000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.54'), 'margin': Decimal('6.563166801559855786917813259'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:14:23,653 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 9272386308
2025-07-04 03:14:23,666 - INFO - orders - [PERF] Order creation: 0.0143s
2025-07-04 03:14:23,667 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 03:14:23,667 - INFO - orders - Publishing order update for user 1
2025-07-04 03:14:23,669 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:14:23,671 - INFO - orders - Publishing market data trigger
2025-07-04 03:14:23,672 - INFO - orders - [PERF] TOTAL place_order: 0.3462s
2025-07-04 03:14:23,710 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 2 open orders, 0 pending orders
2025-07-04 03:14:23,724 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:14:25,380 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCAD, Type: BUY
2025-07-04 03:14:25,690 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8915400000', 'o': '0.8914800000'}
2025-07-04 03:14:25,690 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8915400000, ask=0.89162915400000
2025-07-04 03:14:25,691 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8915400000, ask=0.89162915400000
2025-07-04 03:14:25,692 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 03:14:25,692 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:14:25,693 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:14:25,693 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:14:25,694 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:14:25,696 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3591000000'), 'o': Decimal('1.3590500000')}
2025-07-04 03:14:25,696 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3591000000
2025-07-04 03:14:25,696 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3591000000 = 6.563166801559855786917813259 USD
2025-07-04 03:14:25,696 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89162915400000, Margin: 6.563166801559855786917813259, Commission: 0.10
2025-07-04 03:14:25,710 - INFO - orders - [PERF] Order processing: 0.3291s
2025-07-04 03:14:25,711 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '9413412211', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89162915400000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.63'), 'margin': Decimal('6.563166801559855786917813259'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:14:25,711 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 9413412211
2025-07-04 03:14:25,724 - INFO - orders - [PERF] Order creation: 0.0135s
2025-07-04 03:14:25,724 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 03:14:25,724 - INFO - orders - Publishing order update for user 1
2025-07-04 03:14:25,726 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:14:25,728 - INFO - orders - Publishing market data trigger
2025-07-04 03:14:25,732 - INFO - orders - [PERF] TOTAL place_order: 0.3522s
2025-07-04 03:14:25,762 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 3 open orders, 0 pending orders
2025-07-04 03:14:25,772 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:14:27,509 - INFO - orders - Order close request received - Order ID: 2755759095, User ID: 1, Close Price: 0.89149
2025-07-04 03:14:27,509 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x00000251924A1810>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:14:27,509 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-04 03:14:27,509 - INFO - orders - Request to close order 2755759095 for user 1 (user_type: demo) with price 0.89149. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:14:27,522 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-04 03:14:27,564 - INFO - orders - Existing entry commission for order 2755759095: 0.10000000
2025-07-04 03:14:27,564 - INFO - orders - Commission calculation for order 2755759095: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-04 03:14:27,564 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.139150000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 2755759095)
2025-07-04 03:14:27,564 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:14:27,565 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:14:27,565 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:14:27,565 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:14:27,569 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3591000000'), 'o': Decimal('1.3590400000')}
2025-07-04 03:14:27,570 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3591000000
2025-07-04 03:14:27,570 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.139150000000000000000000 CAD / 1.3591000000 = -0.1023839305422706202634096093 USD
2025-07-04 03:14:27,600 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24971.12000000, margin=6.56
2025-07-04 03:14:27,600 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24971.12000000, margin=6.56
2025-07-04 03:14:27,602 - INFO - orders - User data cache updated for user 1
2025-07-04 03:14:27,602 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-04 03:14:27,602 - INFO - orders - Using order model: DemoUserOrder
2025-07-04 03:14:27,607 - INFO - orders - Fetched 2 open orders for user 1
2025-07-04 03:14:27,611 - INFO - orders - Fetched 0 pending orders for user 1
2025-07-04 03:14:27,612 - INFO - orders - Updated static orders cache for user 1 with 2 open orders and 0 pending orders
2025-07-04 03:14:27,612 - INFO - orders - Publishing order update for user 1
2025-07-04 03:14:27,613 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:14:27,615 - INFO - orders - Publishing market data trigger
2025-07-04 03:14:29,040 - INFO - orders - Order close request received - Order ID: 9272386308, User ID: 1, Close Price: 0.89154
2025-07-04 03:14:29,040 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x00000251920ED940>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:14:29,040 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-04 03:14:29,040 - INFO - orders - Request to close order 9272386308 for user 1 (user_type: demo) with price 0.89154. Frontend provided type: SELL, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:14:29,056 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-04 03:14:29,077 - INFO - orders - Existing entry commission for order 9272386308: 0.10000000
2025-07-04 03:14:29,077 - INFO - orders - Commission calculation for order 9272386308: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-04 03:14:29,077 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 0E-24 CAD to USD for PnL on Close (user_id: 1, position: 9272386308)
2025-07-04 03:14:29,077 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:14:29,079 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:14:29,079 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:14:29,079 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:14:29,081 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3591000000'), 'o': Decimal('1.3590400000')}
2025-07-04 03:14:29,081 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3591000000
2025-07-04 03:14:29,081 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 0E-24 CAD / 1.3591000000 = 0E-14 USD
2025-07-04 03:14:29,081 - ERROR - orders - Order 9272386308: PnL conversion failed. Rates missing for CAD/USD.
2025-07-04 03:14:29,081 - ERROR - orders - Error processing close order: 500: Critical: Could not convert PnL from CAD to USD.
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 1562, in close_order
    raise HTTPException(status_code=500, detail=f"Critical: Could not convert PnL from {profit_currency} to USD.")
fastapi.exceptions.HTTPException: 500: Critical: Could not convert PnL from CAD to USD.
2025-07-04 03:14:29,085 - ERROR - orders - Error in close_order endpoint: 500: Error processing close order: 500: Critical: Could not convert PnL from CAD to USD.
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 1562, in close_order
    raise HTTPException(status_code=500, detail=f"Critical: Could not convert PnL from {profit_currency} to USD.")
fastapi.exceptions.HTTPException: 500: Critical: Could not convert PnL from CAD to USD.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 1633, in close_order
    raise HTTPException(status_code=500, detail=f"Error processing close order: {str(e)}")
fastapi.exceptions.HTTPException: 500: Error processing close order: 500: Critical: Could not convert PnL from CAD to USD.
2025-07-04 03:14:31,072 - INFO - orders - Order close request received - Order ID: 9272386308, User ID: 1, Close Price: 0.89153
2025-07-04 03:14:31,073 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x00000251920ED940>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:14:31,073 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-04 03:14:31,073 - INFO - orders - Request to close order 9272386308 for user 1 (user_type: demo) with price 0.89153. Frontend provided type: SELL, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:14:31,086 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-04 03:14:31,102 - INFO - orders - Existing entry commission for order 9272386308: 0.10000000
2025-07-04 03:14:31,103 - INFO - orders - Commission calculation for order 9272386308: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-04 03:14:31,103 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 0.010000000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 9272386308)
2025-07-04 03:14:31,103 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:14:31,104 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:14:31,105 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:14:31,105 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:14:31,107 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3591000000'), 'o': Decimal('1.3590400000')}
2025-07-04 03:14:31,107 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3591000000
2025-07-04 03:14:31,107 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 0.010000000000000000000000 CAD / 1.3591000000 = 0.007357810315650062541387683026 USD
2025-07-04 03:14:31,138 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24970.93000000, margin=6.56
2025-07-04 03:14:31,139 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24970.93000000, margin=6.56
2025-07-04 03:14:31,141 - INFO - orders - User data cache updated for user 1
2025-07-04 03:14:31,141 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-04 03:14:31,141 - INFO - orders - Using order model: DemoUserOrder
2025-07-04 03:14:31,147 - INFO - orders - Fetched 1 open orders for user 1
2025-07-04 03:14:31,150 - INFO - orders - Fetched 0 pending orders for user 1
2025-07-04 03:14:31,151 - INFO - orders - Updated static orders cache for user 1 with 1 open orders and 0 pending orders
2025-07-04 03:14:31,151 - INFO - orders - Publishing order update for user 1
2025-07-04 03:14:31,154 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:14:31,156 - INFO - orders - Publishing market data trigger
2025-07-04 03:14:32,975 - INFO - orders - Order close request received - Order ID: 9413412211, User ID: 1, Close Price: 0.89148
2025-07-04 03:14:32,975 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x00000251924A1220>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 03:14:32,975 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-04 03:14:32,975 - INFO - orders - Request to close order 9413412211 for user 1 (user_type: demo) with price 0.89148. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 03:14:32,988 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-04 03:14:33,003 - INFO - orders - Existing entry commission for order 9413412211: 0.10000000
2025-07-04 03:14:33,003 - INFO - orders - Commission calculation for order 9413412211: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-04 03:14:33,003 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.149150000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 9413412211)
2025-07-04 03:14:33,003 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:14:33,004 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:14:33,004 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:14:33,004 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:14:33,004 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3591000000'), 'o': Decimal('1.3590400000')}
2025-07-04 03:14:33,005 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3591000000
2025-07-04 03:14:33,005 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.149150000000000000000000 CAD / 1.3591000000 = -0.1097417408579206828047972923 USD
2025-07-04 03:14:33,025 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24970.62000000, margin=0
2025-07-04 03:14:33,025 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24970.62000000, margin=0
2025-07-04 03:14:33,030 - INFO - orders - User data cache updated for user 1
2025-07-04 03:14:33,030 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-04 03:14:33,030 - INFO - orders - Using order model: DemoUserOrder
2025-07-04 03:14:33,034 - INFO - orders - Fetched 0 open orders for user 1
2025-07-04 03:14:33,039 - INFO - orders - Fetched 0 pending orders for user 1
2025-07-04 03:14:33,040 - INFO - orders - Updated static orders cache for user 1 with 0 open orders and 0 pending orders
2025-07-04 03:14:33,040 - INFO - orders - Publishing order update for user 1
2025-07-04 03:14:33,042 - INFO - orders - Publishing user data update for user 1
2025-07-04 03:14:33,044 - INFO - orders - Publishing market data trigger
2025-07-04 03:22:12,532 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:22:12,532 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:22:36,481 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:22:36,481 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:23:16,331 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 03:23:31,785 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-04 03:23:32,094 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8917700000', 'o': '0.8917300000'}
2025-07-04 03:23:32,094 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8917700000, ask=0.89185917700000
2025-07-04 03:23:32,094 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8917700000, ask=0.89185917700000
2025-07-04 03:23:32,096 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 03:23:32,096 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:23:32,098 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:23:32,098 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:23:32,098 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:23:32,099 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3592400000'), 'o': Decimal('1.3592200000')}
2025-07-04 03:23:32,100 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3592400000
2025-07-04 03:23:32,100 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3592400000 = 6.562490803684411877225508372 USD
2025-07-04 03:23:32,100 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89185917700000, Margin: 6.562490803684411877225508372, Commission: 0.00
2025-07-04 03:23:32,102 - INFO - orders - [PERF] Order processing: 0.3134s
2025-07-04 03:23:32,103 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '9038153764', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89185917700000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.86'), 'margin': Decimal('6.562490803684411877225508372'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:23:32,103 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 9038153764
2025-07-04 03:23:32,133 - INFO - orders - [PERF] Order creation: 0.0307s
2025-07-04 03:23:32,133 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 03:23:32,133 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 03:23:32,133 - INFO - orders - Publishing order update for user 4
2025-07-04 03:23:32,134 - INFO - orders - Publishing user data update for user 4
2025-07-04 03:23:32,137 - INFO - orders - Publishing market data trigger
2025-07-04 03:23:32,139 - INFO - orders - [PERF] TOTAL place_order: 0.3552s
2025-07-04 03:23:32,196 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:23:32,246 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:23:32,253 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 03:23:32,255 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '9038153764', 'user_id': 4, 'symbol': 'AUDCAD', 'order_type': 'BUY', 'quantity': 0.01, 'price': 0.891859177, 'status': 'OPEN', 'contract_value': 891.86}
2025-07-04 03:23:57,642 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 03:24:36,462 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:24:36,462 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:24:40,998 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:24:40,998 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:24:42,619 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCHF, Type: BUY
2025-07-04 03:24:42,943 - INFO - orders - [MARGIN_CALC] Market data for AUDCHF: {'b': '0.5206200000', 'o': '0.5205700000'}
2025-07-04 03:24:42,943 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCHF, using bid price with spread: bid=0.5206200000, ask=0.52067206200000
2025-07-04 03:24:42,943 - INFO - orders - [MARGIN_CALC] Using prices for AUDCHF: bid=0.5206200000, ask=0.52067206200000
2025-07-04 03:24:42,944 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.21 CHF to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 03:24:42,944 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-04 03:24:42,944 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:24:42,944 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-04 03:24:42,944 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-04 03:24:42,944 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7935500000'), 'o': Decimal('0.7935200000')}
2025-07-04 03:24:42,944 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7935500000
2025-07-04 03:24:42,944 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.21 CHF / 0.7935500000 = 6.565433810093881923004221536 USD
2025-07-04 03:24:42,945 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCHF, Type: BUY, Qty: 0.01, Price: 0.52067206200000, Margin: 6.565433810093881923004221536, Commission: 0.10
2025-07-04 03:24:42,945 - INFO - orders - [PERF] Order processing: 0.3241s
2025-07-04 03:24:42,945 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '4740618800', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_price': Decimal('0.52067206200000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('520.67'), 'margin': Decimal('6.565433810093881923004221536'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:24:42,946 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 4740618800
2025-07-04 03:24:42,966 - INFO - orders - [PERF] Order creation: 0.0206s
2025-07-04 03:24:42,966 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 03:24:42,966 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 03:24:42,966 - INFO - orders - Publishing order update for user 4
2025-07-04 03:24:42,967 - INFO - orders - Publishing user data update for user 4
2025-07-04 03:24:42,968 - INFO - orders - Publishing market data trigger
2025-07-04 03:24:42,968 - INFO - orders - [PERF] TOTAL place_order: 0.3493s
2025-07-04 03:24:42,976 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:24:42,978 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:24:42,978 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 03:24:42,979 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '4740618800', 'user_id': 4, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'quantity': 0.01, 'price': 0.520672062, 'status': 'OPEN', 'contract_value': 520.67}
2025-07-04 03:25:32,278 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCHF, Type: BUY
2025-07-04 03:25:32,608 - INFO - orders - [MARGIN_CALC] Market data for AUDCHF: {'b': '0.5205900000', 'o': '0.5205300000'}
2025-07-04 03:25:32,608 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCHF, using bid price with spread: bid=0.5205900000, ask=0.52064205900000
2025-07-04 03:25:32,608 - INFO - orders - [MARGIN_CALC] Using prices for AUDCHF: bid=0.5205900000, ask=0.52064205900000
2025-07-04 03:25:32,609 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.21 CHF to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 03:25:32,609 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-04 03:25:32,610 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:25:32,610 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-04 03:25:32,610 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-04 03:25:32,611 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7935300000'), 'o': Decimal('0.7935000000')}
2025-07-04 03:25:32,611 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7935300000
2025-07-04 03:25:32,611 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.21 CHF / 0.7935300000 = 6.565599284211056922863659849 USD
2025-07-04 03:25:32,611 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCHF, Type: BUY, Qty: 0.01, Price: 0.52064205900000, Margin: 6.565599284211056922863659849, Commission: 0.10
2025-07-04 03:25:32,613 - INFO - orders - [PERF] Order processing: 0.3329s
2025-07-04 03:25:32,613 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '9077224176', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_price': Decimal('0.52064205900000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('520.64'), 'margin': Decimal('6.565599284211056922863659849'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:25:32,614 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 9077224176
2025-07-04 03:25:32,626 - INFO - orders - [PERF] Order creation: 0.0125s
2025-07-04 03:25:32,626 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 03:25:32,626 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 03:25:32,626 - INFO - orders - Publishing order update for user 4
2025-07-04 03:25:32,626 - INFO - orders - Publishing user data update for user 4
2025-07-04 03:25:32,628 - INFO - orders - Publishing market data trigger
2025-07-04 03:25:32,629 - INFO - orders - [PERF] TOTAL place_order: 0.3513s
2025-07-04 03:25:32,642 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:25:32,650 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:25:32,652 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 03:25:32,657 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '9077224176', 'user_id': 4, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'quantity': 0.01, 'price': 0.520642059, 'status': 'OPEN', 'contract_value': 520.64}
2025-07-04 03:25:57,138 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:25:57,138 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:26:00,138 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCHF, Type: BUY
2025-07-04 03:26:00,466 - INFO - orders - [MARGIN_CALC] Market data for AUDCHF: {'b': '0.5205700000', 'o': '0.5205200000'}
2025-07-04 03:26:00,466 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCHF, using bid price with spread: bid=0.5205700000, ask=0.52062205700000
2025-07-04 03:26:00,466 - INFO - orders - [MARGIN_CALC] Using prices for AUDCHF: bid=0.5205700000, ask=0.52062205700000
2025-07-04 03:26:00,466 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.21 CHF to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 03:26:00,467 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-04 03:26:00,467 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:26:00,467 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-04 03:26:00,467 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-04 03:26:00,468 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7934500000'), 'o': Decimal('0.7934200000')}
2025-07-04 03:26:00,468 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7934500000
2025-07-04 03:26:00,468 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.21 CHF / 0.7934500000 = 6.566261264099817253765202596 USD
2025-07-04 03:26:00,468 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCHF, Type: BUY, Qty: 0.01, Price: 0.52062205700000, Margin: 6.566261264099817253765202596, Commission: 0.10
2025-07-04 03:26:00,468 - INFO - orders - [PERF] Order processing: 0.3285s
2025-07-04 03:26:00,468 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '1942481024', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_price': Decimal('0.52062205700000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('520.62'), 'margin': Decimal('6.566261264099817253765202596'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:26:00,469 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 1942481024
2025-07-04 03:26:00,491 - INFO - orders - [PERF] Order creation: 0.0232s
2025-07-04 03:26:00,492 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 03:26:00,492 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 03:26:00,492 - INFO - orders - Publishing order update for user 4
2025-07-04 03:26:00,495 - INFO - orders - Publishing user data update for user 4
2025-07-04 03:26:00,499 - INFO - orders - Publishing market data trigger
2025-07-04 03:26:00,501 - INFO - orders - [PERF] TOTAL place_order: 0.3630s
2025-07-04 03:26:00,518 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:26:00,520 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:26:00,520 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 03:26:00,522 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '1942481024', 'user_id': 4, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': 0.01, 'price': 0.520622057, 'status': 'OPEN', 'contract_value': 520.62}
2025-07-04 03:28:32,803 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: CADJPY, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:28:32,814 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:28:32,814 - ERROR - orders - Unexpected error in place_order: name 'user_id_for_operation' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 691, in place_pending_order
    user_data = await get_user_data_cache(redis_client, user_id_for_operation, db, user_type)
                                                        ^^^^^^^^^^^^^^^^^^^^^
NameError: name 'user_id_for_operation' is not defined
2025-07-04 03:28:38,783 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: CADJPY, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:28:38,805 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:28:38,805 - ERROR - orders - Unexpected error in place_order: name 'user_id_for_operation' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 691, in place_pending_order
    user_data = await get_user_data_cache(redis_client, user_id_for_operation, db, user_type)
                                                        ^^^^^^^^^^^^^^^^^^^^^
NameError: name 'user_id_for_operation' is not defined
2025-07-04 03:29:42,830 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:29:42,830 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:29:52,175 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: CADJPY, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:29:52,198 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:29:52,201 - INFO - orders - [DEBUG] User data from cache: {'id': 4, 'email': 'dhanush777ss@gmail.com', 'account_number': 'DYY5A', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('6599.06000000'), 'margin': Decimal('26.22000000'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'string', 'phone_number': Decimal('8618025298')}
2025-07-04 03:29:52,201 - INFO - orders - [DEBUG] Group name: Standard
2025-07-04 03:29:52,203 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 03:29:52,203 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 03:29:52,203 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 03:29:52,204 - INFO - orders - User 4 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-04 03:29:52,212 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for CADJPY: contract_size=100000.00000000, profit_currency=JPY, digit=3.00000
2025-07-04 03:29:52,214 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 03:29:52,216 - INFO - orders - Calculated initial margin: None, commission: None for pending order 8769661749
2025-07-04 03:29:52,230 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '8769661749', 'order_company_name': 'CADJPY', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('100'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '7970355873', 'takeprofit_id': '9241067778', 'order_user_id': 4, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 03:29:52,231 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-04 03:29:52,231 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 4 at price 100
2025-07-04 03:29:52,231 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '8769661749', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'CADJPY', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('100'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '7970355873', 'takeprofit_id': '9241067778', 'close_id': None}
2025-07-04 03:29:52,231 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '8769661749', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'CADJPY', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('100'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '7970355873', 'takeprofit_id': '9241067778', 'close_id': None}
2025-07-04 03:29:52,232 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 8769661749
2025-07-04 03:29:52,579 - INFO - orders - Order 8769661749 verified in database on attempt 1 before adding to Redis.
2025-07-04 03:29:52,585 - INFO - orders - Barclays live user detected. Sending pending order to Firebase.
2025-07-04 03:29:52,585 - INFO - orders - [FIREBASE] Prepared Firebase payload for pending order: {'order_id': '8769661749', 'order_user_id': 4, 'order_company_name': 'CADJPY', 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING_PROCESSING', 'order_price': '100.00000000', 'order_quantity': '0.01000000', 'contract_value': '1000.00000000', 'margin': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': '7970355873', 'takeprofit_id': '9241067778', 'status': 'PENDING', 'action': 'pending_order', 'timestamp': '2025-07-04T10:29:52.585717+00:00'}
2025-07-04 03:29:52,898 - INFO - orders - [FIREBASE] Successfully sent pending order 8769661749 to Firebase for Barclays user 4
2025-07-04 03:29:52,898 - INFO - orders - Skipping Redis storage for Barclays user pending order 8769661749
2025-07-04 03:29:52,904 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 938, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 03:29:52,911 - ERROR - orders - Unexpected error in place_order: name 'background_tasks' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 945, in place_pending_order
    if background_tasks:
       ^^^^^^^^^^^^^^^^
NameError: name 'background_tasks' is not defined. Did you mean: 'BackgroundTasks'?
2025-07-04 03:30:00,094 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: CADJPY, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:30:00,101 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:30:00,102 - INFO - orders - [DEBUG] User data from cache: {'id': 4, 'email': 'dhanush777ss@gmail.com', 'account_number': 'DYY5A', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('6599.06000000'), 'margin': Decimal('26.22000000'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'string', 'phone_number': Decimal('8618025298')}
2025-07-04 03:30:00,102 - INFO - orders - [DEBUG] Group name: Standard
2025-07-04 03:30:00,104 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 03:30:00,104 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 03:30:00,104 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 03:30:00,104 - INFO - orders - User 4 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-04 03:30:00,106 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for CADJPY: contract_size=100000.00000000, profit_currency=JPY, digit=3.00000
2025-07-04 03:30:00,108 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 03:30:00,109 - INFO - orders - Calculated initial margin: None, commission: None for pending order 4496364031
2025-07-04 03:30:00,116 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '4496364031', 'order_company_name': 'CADJPY', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('100'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '9387551319', 'takeprofit_id': '2387190981', 'order_user_id': 4, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 03:30:00,116 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-04 03:30:00,117 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 4 at price 100
2025-07-04 03:30:00,117 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '4496364031', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'CADJPY', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('100'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '9387551319', 'takeprofit_id': '2387190981', 'close_id': None}
2025-07-04 03:30:00,117 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '4496364031', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'CADJPY', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('100'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '9387551319', 'takeprofit_id': '2387190981', 'close_id': None}
2025-07-04 03:30:00,118 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 4496364031
2025-07-04 03:30:00,142 - INFO - orders - Order 4496364031 verified in database on attempt 1 before adding to Redis.
2025-07-04 03:30:00,143 - INFO - orders - Barclays live user detected. Sending pending order to Firebase.
2025-07-04 03:30:00,144 - INFO - orders - [FIREBASE] Prepared Firebase payload for pending order: {'order_id': '4496364031', 'order_user_id': 4, 'order_company_name': 'CADJPY', 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING_PROCESSING', 'order_price': '100.00000000', 'order_quantity': '0.01000000', 'contract_value': '1000.00000000', 'margin': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': '9387551319', 'takeprofit_id': '2387190981', 'status': 'PENDING', 'action': 'pending_order', 'timestamp': '2025-07-04T10:30:00.144088+00:00'}
2025-07-04 03:30:00,431 - INFO - orders - [FIREBASE] Successfully sent pending order 4496364031 to Firebase for Barclays user 4
2025-07-04 03:30:00,431 - INFO - orders - Skipping Redis storage for Barclays user pending order 4496364031
2025-07-04 03:30:00,434 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 938, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 03:30:00,436 - ERROR - orders - Unexpected error in place_order: name 'background_tasks' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 945, in place_pending_order
    if background_tasks:
       ^^^^^^^^^^^^^^^^
NameError: name 'background_tasks' is not defined. Did you mean: 'BackgroundTasks'?
2025-07-04 03:31:05,919 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:31:05,919 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:31:11,217 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: CADJPY, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:31:11,235 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:31:11,236 - INFO - orders - [DEBUG] User data from cache: {'id': 4, 'email': 'dhanush777ss@gmail.com', 'account_number': 'DYY5A', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('6599.06000000'), 'margin': Decimal('26.22000000'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'string', 'phone_number': Decimal('8618025298')}
2025-07-04 03:31:11,237 - INFO - orders - [DEBUG] Group name: Standard
2025-07-04 03:31:11,238 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 03:31:11,238 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 03:31:11,239 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 03:31:11,239 - INFO - orders - User 4 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-04 03:31:11,241 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for CADJPY: contract_size=100000.00000000, profit_currency=JPY, digit=3.00000
2025-07-04 03:31:11,241 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 03:31:11,243 - INFO - orders - Calculated initial margin: None, commission: None for pending order 5058258906
2025-07-04 03:31:11,251 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '5058258906', 'order_company_name': 'CADJPY', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('100'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '4169413636', 'takeprofit_id': '9162516544', 'order_user_id': 4, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 03:31:11,252 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-04 03:31:11,252 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 4 at price 100
2025-07-04 03:31:11,252 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '5058258906', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'CADJPY', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('100'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '4169413636', 'takeprofit_id': '9162516544', 'close_id': None}
2025-07-04 03:31:11,252 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '5058258906', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'CADJPY', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('100'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '4169413636', 'takeprofit_id': '9162516544', 'close_id': None}
2025-07-04 03:31:11,253 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 5058258906
2025-07-04 03:31:11,285 - INFO - orders - Order 5058258906 verified in database on attempt 1 before adding to Redis.
2025-07-04 03:31:11,287 - INFO - orders - Barclays live user detected. Sending pending order to Firebase.
2025-07-04 03:31:11,287 - INFO - orders - [FIREBASE] Prepared Firebase payload for pending order: {'order_id': '5058258906', 'order_user_id': 4, 'order_company_name': 'CADJPY', 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING_PROCESSING', 'order_price': '100.00000000', 'order_quantity': '0.01000000', 'contract_value': '1000.00000000', 'margin': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': '4169413636', 'takeprofit_id': '9162516544', 'status': 'PENDING', 'action': 'pending_order', 'timestamp': '2025-07-04T10:31:11.287642+00:00'}
2025-07-04 03:31:11,621 - INFO - orders - [FIREBASE] Successfully sent pending order 5058258906 to Firebase for Barclays user 4
2025-07-04 03:31:11,622 - INFO - orders - Skipping Redis storage for Barclays user pending order 5058258906
2025-07-04 03:31:11,627 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 939, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 03:31:11,634 - ERROR - orders - Unexpected error in place_order: name 'update_user_cache' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 947, in place_pending_order
    background_tasks.add_task(update_user_cache)
                              ^^^^^^^^^^^^^^^^^
NameError: name 'update_user_cache' is not defined. Did you mean: 'update_user_margin'?
2025-07-04 03:37:17,716 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:37:17,716 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:37:26,974 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: AUDCAD, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:37:27,000 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:37:27,003 - INFO - orders - [DEBUG] User data from cache: {'id': 4, 'email': 'dhanush777ss@gmail.com', 'account_number': 'DYY5A', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('6599.06000000'), 'margin': Decimal('26.22000000'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'string', 'phone_number': Decimal('8618025298')}
2025-07-04 03:37:27,003 - INFO - orders - [DEBUG] Group name: Standard
2025-07-04 03:37:27,006 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 03:37:27,006 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 03:37:27,006 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 03:37:27,006 - INFO - orders - User 4 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-04 03:37:27,012 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-07-04 03:37:27,014 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 03:37:27,016 - INFO - orders - Calculated initial margin: None, commission: None for pending order 2868349752
2025-07-04 03:37:27,026 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '2868349752', 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.88'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '9174483224', 'takeprofit_id': '6818296640', 'order_user_id': 4, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 03:37:27,027 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-04 03:37:27,027 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 4 at price 0.88
2025-07-04 03:37:27,027 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '2868349752', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '9174483224', 'takeprofit_id': '6818296640', 'close_id': None}
2025-07-04 03:37:27,027 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '2868349752', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '9174483224', 'takeprofit_id': '6818296640', 'close_id': None}
2025-07-04 03:37:27,028 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 2868349752
2025-07-04 03:37:27,094 - INFO - orders - Order 2868349752 verified in database on attempt 1 before adding to Redis.
2025-07-04 03:37:27,098 - INFO - orders - Barclays live user detected. Sending pending order to Firebase.
2025-07-04 03:37:27,098 - INFO - orders - [FIREBASE] Prepared Firebase payload for pending order: {'order_id': '2868349752', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING_PROCESSING', 'order_price': '0.88000000', 'order_quantity': '0.01000000', 'contract_value': '1000.00000000', 'margin': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': '9174483224', 'takeprofit_id': '6818296640', 'status': 'PENDING', 'action': 'pending_order', 'timestamp': '2025-07-04T10:37:27.098384+00:00'}
2025-07-04 03:37:27,384 - INFO - orders - [FIREBASE] Successfully sent pending order 2868349752 to Firebase for Barclays user 4
2025-07-04 03:37:27,384 - INFO - orders - Skipping Redis storage for Barclays user pending order 2868349752
2025-07-04 03:37:27,391 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 939, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 03:37:27,402 - ERROR - orders - Unexpected error in place_order: name 'update_user_cache' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 947, in place_pending_order
    background_tasks.add_task(update_user_cache, user_id, db, redis_client, user_type)
                              ^^^^^^^^^^^^^^^^^
NameError: name 'update_user_cache' is not defined. Did you mean: 'update_user_margin'?
2025-07-04 03:37:59,320 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-04 03:37:59,617 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8914700000', 'o': '0.8914200000'}
2025-07-04 03:37:59,618 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8914700000, ask=0.89155914700000
2025-07-04 03:37:59,618 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8914700000, ask=0.89155914700000
2025-07-04 03:37:59,619 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 03:37:59,619 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:37:59,620 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:37:59,620 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:37:59,620 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:37:59,620 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3592900000'), 'o': Decimal('1.3592600000')}
2025-07-04 03:37:59,620 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3592900000
2025-07-04 03:37:59,620 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3592900000 = 6.562249409618256589837341553 USD
2025-07-04 03:37:59,620 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89155914700000, Margin: 6.562249409618256589837341553, Commission: 0.00
2025-07-04 03:37:59,621 - INFO - orders - [PERF] Order processing: 0.2990s
2025-07-04 03:37:59,621 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '4753216372', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89155914700000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.56'), 'margin': Decimal('6.562249409618256589837341553'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:37:59,621 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 4753216372
2025-07-04 03:37:59,634 - INFO - orders - [PERF] Order creation: 0.0131s
2025-07-04 03:37:59,634 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 03:37:59,634 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 03:37:59,634 - INFO - orders - Publishing order update for user 4
2025-07-04 03:37:59,634 - INFO - orders - Publishing user data update for user 4
2025-07-04 03:37:59,636 - INFO - orders - Publishing market data trigger
2025-07-04 03:37:59,639 - INFO - orders - [PERF] TOTAL place_order: 0.3192s
2025-07-04 03:37:59,667 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:37:59,689 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:37:59,692 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 03:37:59,694 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '4753216372', 'user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': 0.01, 'price': 0.891559147, 'status': 'OPEN', 'contract_value': 891.56}
2025-07-04 03:38:50,502 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:38:50,503 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:38:57,722 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: AUDCAD, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:38:57,738 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:38:57,740 - INFO - orders - [DEBUG] User data from cache: {'id': 4, 'email': 'dhanush777ss@gmail.com', 'account_number': 'DYY5A', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('6599.06000000'), 'margin': Decimal('26.22000000'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'string', 'phone_number': Decimal('8618025298')}
2025-07-04 03:38:57,740 - INFO - orders - [DEBUG] Group name: Standard
2025-07-04 03:38:57,741 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 03:38:57,741 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 03:38:57,741 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 03:38:57,741 - INFO - orders - User 4 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-04 03:38:57,743 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-07-04 03:38:57,745 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 03:38:57,747 - INFO - orders - Calculated initial margin: None, commission: None for pending order 9914707583
2025-07-04 03:38:57,756 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '9914707583', 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.88'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '4901657968', 'takeprofit_id': '3015454285', 'order_user_id': 4, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 03:38:57,756 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-04 03:38:57,756 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 4 at price 0.88
2025-07-04 03:38:57,757 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '9914707583', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '4901657968', 'takeprofit_id': '3015454285', 'close_id': None}
2025-07-04 03:38:57,757 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '9914707583', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '4901657968', 'takeprofit_id': '3015454285', 'close_id': None}
2025-07-04 03:38:57,758 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 9914707583
2025-07-04 03:38:57,795 - INFO - orders - Order 9914707583 verified in database on attempt 1 before adding to Redis.
2025-07-04 03:38:57,798 - INFO - orders - Barclays live user detected. Sending pending order to Firebase.
2025-07-04 03:38:57,798 - INFO - orders - [FIREBASE] Prepared Firebase payload for pending order: {'order_id': '9914707583', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING_PROCESSING', 'order_price': '0.88000000', 'order_quantity': '0.01000000', 'contract_value': '1000.00000000', 'margin': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': '4901657968', 'takeprofit_id': '3015454285', 'status': 'PENDING', 'action': 'pending_order', 'timestamp': '2025-07-04T10:38:57.798335+00:00'}
2025-07-04 03:38:58,103 - INFO - orders - [FIREBASE] Successfully sent pending order 9914707583 to Firebase for Barclays user 4
2025-07-04 03:38:58,103 - INFO - orders - Skipping Redis storage for Barclays user pending order 9914707583
2025-07-04 03:38:58,112 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 939, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 03:38:58,122 - ERROR - orders - Unexpected error in place_order: name 'update_user_cache' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 947, in place_pending_order
    background_tasks.add_task(update_user_cache, user_id_for_order, db, redis_client, user_type)
                              ^^^^^^^^^^^^^^^^^
NameError: name 'update_user_cache' is not defined. Did you mean: 'update_user_margin'?
2025-07-04 03:40:13,588 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:40:13,588 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:40:18,446 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: AUDCAD, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:40:18,458 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:40:18,459 - INFO - orders - [DEBUG] User data from cache: {'id': 4, 'email': 'dhanush777ss@gmail.com', 'account_number': 'DYY5A', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('6599.06000000'), 'margin': Decimal('26.22000000'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'string', 'phone_number': Decimal('8618025298')}
2025-07-04 03:40:18,459 - INFO - orders - [DEBUG] Group name: Standard
2025-07-04 03:40:18,460 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 03:40:18,460 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 03:40:18,461 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 03:40:18,461 - INFO - orders - User 4 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-04 03:40:18,464 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-07-04 03:40:18,465 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 03:40:18,467 - INFO - orders - Calculated initial margin: None, commission: None for pending order 4916602425
2025-07-04 03:40:18,486 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '4916602425', 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.88'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '9801057304', 'takeprofit_id': '2509566086', 'order_user_id': 4, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 03:40:18,487 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-04 03:40:18,487 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 4 at price 0.88
2025-07-04 03:40:18,488 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '4916602425', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '9801057304', 'takeprofit_id': '2509566086', 'close_id': None}
2025-07-04 03:40:18,489 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '4916602425', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '9801057304', 'takeprofit_id': '2509566086', 'close_id': None}
2025-07-04 03:40:18,491 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 4916602425
2025-07-04 03:40:18,551 - INFO - orders - Order 4916602425 verified in database on attempt 1 before adding to Redis.
2025-07-04 03:40:18,554 - INFO - orders - Barclays live user detected. Sending pending order to Firebase.
2025-07-04 03:40:18,554 - INFO - orders - [FIREBASE] Prepared Firebase payload for pending order: {'order_id': '4916602425', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING_PROCESSING', 'order_price': '0.88000000', 'order_quantity': '0.01000000', 'contract_value': '1000.00000000', 'margin': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': '9801057304', 'takeprofit_id': '2509566086', 'status': 'PENDING', 'action': 'pending_order', 'timestamp': '2025-07-04T10:40:18.554618+00:00'}
2025-07-04 03:40:18,897 - INFO - orders - [FIREBASE] Successfully sent pending order 4916602425 to Firebase for Barclays user 4
2025-07-04 03:40:18,897 - INFO - orders - Skipping Redis storage for Barclays user pending order 4916602425
2025-07-04 03:40:18,902 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 941, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 03:40:18,911 - ERROR - orders - Unexpected error in place_order: name 'start_total' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 1008, in place_pending_order
    orders_logger.info(f"[PERF] TOTAL place_order: {time.perf_counter() - start_total:.4f}s")
                                                                          ^^^^^^^^^^^
NameError: name 'start_total' is not defined
2025-07-04 03:41:12,163 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:41:12,163 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:41:28,272 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:41:28,272 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:41:30,207 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: AUDCAD, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:41:30,221 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:41:30,223 - INFO - orders - [DEBUG] User data from cache: {'id': 4, 'email': 'dhanush777ss@gmail.com', 'account_number': 'DYY5A', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('6599.06000000'), 'margin': Decimal('26.22000000'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'string', 'phone_number': Decimal('8618025298')}
2025-07-04 03:41:30,223 - INFO - orders - [DEBUG] Group name: Standard
2025-07-04 03:41:30,228 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 03:41:30,228 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 03:41:30,228 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 03:41:30,228 - INFO - orders - User 4 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-04 03:41:30,242 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-07-04 03:41:30,245 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 03:41:30,245 - INFO - orders - Calculated initial margin: None, commission: None for pending order 8929428488
2025-07-04 03:41:30,249 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '8929428488', 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.88'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '6422733764', 'takeprofit_id': '6501516809', 'order_user_id': 4, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 03:41:30,249 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-04 03:41:30,249 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 4 at price 0.88
2025-07-04 03:41:30,249 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '8929428488', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '6422733764', 'takeprofit_id': '6501516809', 'close_id': None}
2025-07-04 03:41:30,249 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '8929428488', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '6422733764', 'takeprofit_id': '6501516809', 'close_id': None}
2025-07-04 03:41:30,249 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 8929428488
2025-07-04 03:41:30,278 - INFO - orders - Order 8929428488 verified in database on attempt 1 before adding to Redis.
2025-07-04 03:41:30,281 - INFO - orders - Barclays live user detected. Sending pending order to Firebase.
2025-07-04 03:41:30,281 - INFO - orders - [FIREBASE] Prepared Firebase payload for pending order: {'order_id': '8929428488', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING_PROCESSING', 'order_price': '0.88000000', 'order_quantity': '0.01000000', 'contract_value': '1000.00000000', 'margin': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': '6422733764', 'takeprofit_id': '6501516809', 'status': 'PENDING', 'action': 'pending_order', 'timestamp': '2025-07-04T10:41:30.281690+00:00'}
2025-07-04 03:41:30,589 - INFO - orders - [FIREBASE] Successfully sent pending order 8929428488 to Firebase for Barclays user 4
2025-07-04 03:41:30,595 - INFO - orders - Skipping Redis storage for Barclays user pending order 8929428488
2025-07-04 03:41:30,601 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 942, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 03:41:30,610 - INFO - orders - [PERF] TOTAL place_order: 0.4034s
2025-07-04 03:41:30,647 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:41:30,653 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:41:46,475 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:41:46,475 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:41:50,717 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-04 03:41:51,042 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8911800000', 'o': '0.8911300000'}
2025-07-04 03:41:51,043 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8911800000, ask=0.89126911800000
2025-07-04 03:41:51,044 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8911800000, ask=0.89126911800000
2025-07-04 03:41:51,046 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.91 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 03:41:51,046 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 03:41:51,048 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 03:41:51,048 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 03:41:51,048 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 03:41:51,050 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3593900000'), 'o': Decimal('1.3593400000')}
2025-07-04 03:41:51,050 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3593900000
2025-07-04 03:41:51,051 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.91 CAD / 1.3593900000 = 6.554410434091761746077284664 USD
2025-07-04 03:41:51,051 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89126911800000, Margin: 6.554410434091761746077284664, Commission: 0.00
2025-07-04 03:41:51,052 - INFO - orders - [PERF] Order processing: 0.3326s
2025-07-04 03:41:51,052 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '4640287808', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89126911800000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.27'), 'margin': Decimal('6.554410434091761746077284664'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 03:41:51,054 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 4640287808
2025-07-04 03:41:51,083 - INFO - orders - [PERF] Order creation: 0.0313s
2025-07-04 03:41:51,084 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 03:41:51,084 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 03:41:51,084 - INFO - orders - Publishing order update for user 4
2025-07-04 03:41:51,085 - INFO - orders - Publishing user data update for user 4
2025-07-04 03:41:51,087 - INFO - orders - Publishing market data trigger
2025-07-04 03:41:51,089 - INFO - orders - [PERF] TOTAL place_order: 0.3738s
2025-07-04 03:41:51,113 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:41:51,120 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:41:51,121 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 03:41:51,124 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '4640287808', 'user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': 0.01, 'price': 0.891269118, 'status': 'OPEN', 'contract_value': 891.27}
2025-07-04 03:48:01,949 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:48:01,949 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:48:15,522 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: AUDCAD, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:48:15,537 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:48:15,539 - INFO - orders - [DEBUG] User data from cache: {'id': 4, 'email': 'dhanush777ss@gmail.com', 'account_number': 'DYY5A', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('6599.06000000'), 'margin': Decimal('26.22000000'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'string', 'phone_number': Decimal('8618025298')}
2025-07-04 03:48:15,539 - INFO - orders - [DEBUG] Group name: Standard
2025-07-04 03:48:15,540 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 03:48:15,540 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 03:48:15,540 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 03:48:15,540 - INFO - orders - User 4 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-04 03:48:15,545 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-07-04 03:48:15,546 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 03:48:15,548 - INFO - orders - Calculated initial margin: None, commission: None for pending order 3258557327
2025-07-04 03:48:15,555 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '3258557327', 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.88'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '8846594572', 'takeprofit_id': '3094114475', 'order_user_id': 4, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 03:48:15,555 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-04 03:48:15,556 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 4 at price 0.88
2025-07-04 03:48:15,556 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '3258557327', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '8846594572', 'takeprofit_id': '3094114475', 'close_id': None}
2025-07-04 03:48:15,556 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '3258557327', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '8846594572', 'takeprofit_id': '3094114475', 'close_id': None}
2025-07-04 03:48:15,557 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 3258557327
2025-07-04 03:48:15,592 - INFO - orders - Order 3258557327 verified in database on attempt 1 before adding to Redis.
2025-07-04 03:48:15,595 - INFO - orders - Barclays live user detected. Sending pending order to Firebase.
2025-07-04 03:48:15,595 - INFO - orders - [FIREBASE] Prepared Firebase payload for pending order: {'order_id': '3258557327', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING_PROCESSING', 'order_price': '0.88000000', 'order_quantity': '0.01000000', 'contract_value': '1000.00000000', 'margin': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': '8846594572', 'takeprofit_id': '3094114475', 'status': 'PENDING', 'action': 'pending_order', 'timestamp': '2025-07-04T10:48:15.595230+00:00'}
2025-07-04 03:48:15,978 - INFO - orders - [FIREBASE] Successfully sent pending order 3258557327 to Firebase for Barclays user 4
2025-07-04 03:48:15,978 - INFO - orders - Skipping Redis storage for Barclays user pending order 3258557327
2025-07-04 03:48:15,982 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 942, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 03:48:15,989 - INFO - orders - [PERF] TOTAL place_order: 0.4673s
2025-07-04 03:48:16,004 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:48:16,009 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:48:16,012 - INFO - orders - [BARCLAYS] barclays_push called for user 4, is_barclays_live_user=True
2025-07-04 03:48:16,013 - DEBUG - orders - [BARCLAYS] Preparing to send order to Firebase for user_id=4, order_id=3258557327, order_status=PENDING_PROCESSING
2025-07-04 03:48:16,381 - DEBUG - orders - [BARCLAYS] free_margin=6572.84000000, order_margin=0 for user_id=4
2025-07-04 03:48:16,382 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '3258557327', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING_PROCESSING', 'order_price': Decimal('0.88000000'), 'order_quantity': Decimal('0.01000000'), 'contract_value': Decimal('1000.00000000'), 'margin': None, 'stop_loss': Decimal('0E-8'), 'take_profit': Decimal('0E-8')}
2025-07-04 03:49:52,309 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:49:52,309 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:49:57,028 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:49:57,028 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:50:04,262 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: AUDCAD, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:50:04,279 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:50:04,281 - INFO - orders - [DEBUG] User data from cache: {'id': 4, 'email': 'dhanush777ss@gmail.com', 'account_number': 'DYY5A', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('6599.06000000'), 'margin': Decimal('26.22000000'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'string', 'phone_number': Decimal('8618025298')}
2025-07-04 03:50:04,281 - INFO - orders - [DEBUG] Group name: Standard
2025-07-04 03:50:04,281 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 03:50:04,282 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 03:50:04,282 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 03:50:04,282 - INFO - orders - User 4 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-04 03:50:04,284 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-07-04 03:50:04,285 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 03:50:04,288 - INFO - orders - Calculated initial margin: None, commission: None for pending order 5023850276
2025-07-04 03:50:04,296 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '5023850276', 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.88'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '8587275613', 'takeprofit_id': '9044038364', 'order_user_id': 4, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 03:50:04,297 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-04 03:50:04,297 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 4 at price 0.88
2025-07-04 03:50:04,297 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '5023850276', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '8587275613', 'takeprofit_id': '9044038364', 'close_id': None}
2025-07-04 03:50:04,297 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '5023850276', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '8587275613', 'takeprofit_id': '9044038364', 'close_id': None}
2025-07-04 03:50:04,298 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 5023850276
2025-07-04 03:50:04,346 - INFO - orders - Order 5023850276 verified in database on attempt 1 before adding to Redis.
2025-07-04 03:50:04,348 - INFO - orders - Barclays live user detected. Sending pending order to Firebase.
2025-07-04 03:50:04,348 - INFO - orders - [FIREBASE] Prepared Firebase payload for pending order: {'order_id': '5023850276', 'order_company_name': 'AUDCAD', 'order_price': 0.88, 'contract_value': 1000.0, 'order_quantity': 0.01, 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING', 'status': 'PENDING', 'action': 'place_pending_order'}
2025-07-04 03:50:04,717 - INFO - orders - [FIREBASE] Successfully sent pending order 5023850276 to Firebase for Barclays user 4
2025-07-04 03:50:04,717 - INFO - orders - Skipping Redis storage for Barclays user pending order 5023850276
2025-07-04 03:50:04,726 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 935, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 03:50:04,736 - INFO - orders - [PERF] TOTAL place_order: 0.4733s
2025-07-04 03:50:04,852 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:50:04,862 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:50:04,904 - INFO - orders - [BARCLAYS] barclays_push called for user 4, is_barclays_live_user=True
2025-07-04 03:50:04,905 - DEBUG - orders - [BARCLAYS] Preparing to send order to Firebase for user_id=4, order_id=5023850276, order_status=PENDING_PROCESSING
2025-07-04 03:50:05,333 - DEBUG - orders - [BARCLAYS] free_margin=6572.84000000, order_margin=0 for user_id=4
2025-07-04 03:50:05,333 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '5023850276', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING_PROCESSING', 'order_price': Decimal('0.88000000'), 'order_quantity': Decimal('0.01000000'), 'contract_value': Decimal('1000.00000000'), 'margin': None, 'stop_loss': Decimal('0E-8'), 'take_profit': Decimal('0E-8')}
2025-07-04 03:50:39,546 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: AUDCAD, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:50:39,568 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:50:39,571 - INFO - orders - [DEBUG] User data from cache: {'id': 4, 'email': 'dhanush777ss@gmail.com', 'account_number': 'DYY5A', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('6599.06000000'), 'margin': Decimal('26.22000000'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'string', 'phone_number': Decimal('8618025298')}
2025-07-04 03:50:39,571 - INFO - orders - [DEBUG] Group name: Standard
2025-07-04 03:50:39,576 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 03:50:39,576 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 03:50:39,577 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 03:50:39,577 - INFO - orders - User 4 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-04 03:50:39,580 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-07-04 03:50:39,584 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 03:50:39,585 - INFO - orders - Calculated initial margin: None, commission: None for pending order 7287201517
2025-07-04 03:50:39,596 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '7287201517', 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.88'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '9902769714', 'takeprofit_id': '9699432335', 'order_user_id': 4, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 03:50:39,596 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-04 03:50:39,596 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 4 at price 0.88
2025-07-04 03:50:39,596 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '7287201517', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '9902769714', 'takeprofit_id': '9699432335', 'close_id': None}
2025-07-04 03:50:39,597 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '7287201517', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '9902769714', 'takeprofit_id': '9699432335', 'close_id': None}
2025-07-04 03:50:39,597 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 7287201517
2025-07-04 03:50:39,628 - INFO - orders - Order 7287201517 verified in database on attempt 1 before adding to Redis.
2025-07-04 03:50:39,632 - INFO - orders - Barclays live user detected. Sending pending order to Firebase.
2025-07-04 03:50:39,633 - INFO - orders - [FIREBASE] Prepared Firebase payload for pending order: {'order_id': '7287201517', 'order_company_name': 'AUDCAD', 'order_price': 0.88, 'contract_value': 1000.0, 'order_quantity': 0.01, 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING', 'status': 'PENDING', 'action': 'place_pending_order'}
2025-07-04 03:50:40,048 - INFO - orders - [FIREBASE] Successfully sent pending order 7287201517 to Firebase for Barclays user 4
2025-07-04 03:50:40,048 - INFO - orders - Skipping Redis storage for Barclays user pending order 7287201517
2025-07-04 03:50:40,057 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 935, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 03:50:40,065 - INFO - orders - [PERF] TOTAL place_order: 0.5189s
2025-07-04 03:50:40,095 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:50:40,102 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:50:40,105 - INFO - orders - [BARCLAYS] barclays_push called for user 4, is_barclays_live_user=True
2025-07-04 03:50:40,105 - DEBUG - orders - [BARCLAYS] Preparing to send order to Firebase for user_id=4, order_id=7287201517, order_status=PENDING_PROCESSING
2025-07-04 03:50:40,558 - DEBUG - orders - [BARCLAYS] free_margin=6572.84000000, order_margin=0 for user_id=4
2025-07-04 03:50:40,558 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '7287201517', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING_PROCESSING', 'order_price': Decimal('0.88000000'), 'order_quantity': Decimal('0.01000000'), 'contract_value': Decimal('1000.00000000'), 'margin': None, 'stop_loss': Decimal('0E-8'), 'take_profit': Decimal('0E-8')}
2025-07-04 03:55:35,731 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:55:35,731 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:56:19,096 - INFO - orders - Pending order placement request received - User ID: 4, Symbol: AUDCAD, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 03:56:19,109 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 03:56:19,110 - INFO - orders - [DEBUG] User data from cache: {'id': 4, 'email': 'dhanush777ss@gmail.com', 'account_number': 'DYY5A', 'group_name': 'Standard', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('6599.06000000'), 'margin': Decimal('26.22000000'), 'user_type': 'live', 'first_name': None, 'last_name': None, 'country': 'string', 'phone_number': Decimal('8618025298')}
2025-07-04 03:56:19,110 - INFO - orders - [DEBUG] Group name: Standard
2025-07-04 03:56:19,111 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 03:56:19,111 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 03:56:19,111 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 03:56:19,111 - INFO - orders - User 4 is_barclays_live_user: True (user_type: live, sending_orders_normalized: barclays)
2025-07-04 03:56:19,114 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-07-04 03:56:19,115 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 03:56:19,116 - INFO - orders - Calculated initial margin: None, commission: None for pending order 7230016134
2025-07-04 03:56:19,123 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '7230016134', 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.88'), 'user_type': 'live', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '6977879297', 'takeprofit_id': '7544428832', 'order_user_id': 4, 'order_status': 'PENDING_PROCESSING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 03:56:19,124 - INFO - orders - [BARCLAYS] Setting initial order_status to PENDING_PROCESSING for Barclays user. Will be updated to PENDING after service provider confirmation.
2025-07-04 03:56:19,124 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 4 at price 0.88
2025-07-04 03:56:19,124 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '7230016134', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '6977879297', 'takeprofit_id': '7544428832', 'close_id': None}
2025-07-04 03:56:19,124 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '7230016134', 'order_status': 'PENDING_PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '6977879297', 'takeprofit_id': '7544428832', 'close_id': None}
2025-07-04 03:56:19,125 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 7230016134
2025-07-04 03:56:19,155 - INFO - orders - Order 7230016134 verified in database on attempt 1 before adding to Redis.
2025-07-04 03:56:19,157 - INFO - orders - Skipping Redis storage for Barclays user pending order 7230016134
2025-07-04 03:56:19,160 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 905, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 03:56:19,165 - INFO - orders - [PERF] TOTAL place_order: 0.0691s
2025-07-04 03:56:19,181 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 03:56:19,183 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 03:56:19,185 - INFO - orders - [BARCLAYS] barclays_push called for user 4, is_barclays_live_user=True
2025-07-04 03:56:19,185 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '7230016134', 'order_company_name': 'AUDCAD', 'order_price': 0.88, 'contract_value': 1000.0, 'order_quantity': 0.01, 'order_type': 'BUY_LIMIT', 'order_status': 'PENDING', 'status': 'PENDING', 'action': 'place_pending_order'}
2025-07-04 03:56:55,096 - INFO - orders - Add stoploss request received - Order ID: 3649865209, User ID: 4
2025-07-04 03:56:55,107 - INFO - orders - Generated stoploss_id: 1744662559 for order 3649865209
2025-07-04 03:56:55,110 - INFO - orders - User 4 is_barclays_live_user: True
2025-07-04 03:56:55,110 - INFO - orders - Barclays user detected. Sending stoploss request to Firebase for order 3649865209
2025-07-04 03:56:55,540 - INFO - orders - Stoploss request sent to Firebase for order 3649865209
2025-07-04 03:57:34,059 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 03:57:34,059 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 03:59:34,790 - INFO - orders - Add takeprofit request received - Order ID: 3649865209, User ID: 4
2025-07-04 03:59:34,805 - INFO - orders - Generated takeprofit_id: 9728998833 for order 3649865209
2025-07-04 03:59:34,813 - INFO - orders - User 4 is_barclays_live_user: True
2025-07-04 03:59:34,813 - INFO - orders - Barclays user detected. Sending takeprofit request to Firebase for order 3649865209
2025-07-04 03:59:35,586 - INFO - orders - Takeprofit request sent to Firebase for order 3649865209
2025-07-04 04:02:06,884 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 04:02:06,884 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 04:02:18,300 - INFO - orders - Order close request received - Order ID: 3649865209, User ID: 4, Close Price: 0.52035
2025-07-04 04:02:18,300 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x0000028B4AE22490>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 04:02:18,301 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-04 04:02:18,301 - INFO - orders - Request to close order 3649865209 for user 4 (user_type: live) with price 0.52035. Frontend provided type: BUY, company: AUDCHF, status: CLOSED, frontend_status: CLOSED.
2025-07-04 04:02:18,307 - INFO - orders - User group: Standard, sending_orders setting: barclays
2025-07-04 04:02:18,307 - INFO - orders - Live user 4 from group 'Standard' has 'sending_orders' set to 'barclays'. Pushing close request to Firebase and skipping local DB update.
2025-07-04 04:02:18,311 - INFO - orders - [FIREBASE_CLOSE_REQUEST] Preparing to send payload for user-initiated close: {'order_id': '3649865209', 'close_price': '0.52035', 'user_id': 4, 'order_type': 'BUY', 'order_company_name': 'AUDCHF', 'order_quantity': '0.01000000', 'contract_value': '520.31000000', 'order_status': 'CLOSED', 'status': 'CLOSED', 'action': 'close_order', 'close_id': '7127234370'}
2025-07-04 04:02:43,717 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 04:02:43,717 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 04:02:49,427 - app.api.v1.endpoints.orders - INFO - [get_closed_orders] user_type: live
2025-07-04 04:02:51,427 - app.api.v1.endpoints.orders - INFO - [get_closed_orders] user_type: live
2025-07-04 04:03:03,910 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 04:03:10,100 - app.api.v1.endpoints.orders - INFO - [get_closed_orders] user_type: live
2025-07-04 04:23:55,963 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 04:23:55,963 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 04:24:01,689 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 04:24:23,239 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 04:24:42,708 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 04:32:25,798 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 04:32:25,799 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 04:32:39,377 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 04:33:00,714 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-07-04 04:33:07,762 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCHF, Type: BUY
2025-07-04 04:33:08,082 - INFO - orders - [MARGIN_CALC] Market data for AUDCHF: {'b': '0.5204400000', 'o': '0.5203800000'}
2025-07-04 04:33:08,083 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCHF, using bid price with spread: bid=0.5204400000, ask=0.52049204400000
2025-07-04 04:33:08,083 - INFO - orders - [MARGIN_CALC] Using prices for AUDCHF: bid=0.5204400000, ask=0.52049204400000
2025-07-04 04:33:08,085 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.20 CHF to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 04:33:08,085 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-04 04:33:08,086 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:33:08,086 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-04 04:33:08,086 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-04 04:33:08,088 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7934900000'), 'o': Decimal('0.7934500000')}
2025-07-04 04:33:08,088 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7934900000
2025-07-04 04:33:08,088 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.20 CHF / 0.7934900000 = 6.553327704192869475355707066 USD
2025-07-04 04:33:08,088 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCHF, Type: BUY, Qty: 0.01, Price: 0.52049204400000, Margin: 6.553327704192869475355707066, Commission: 0.10
2025-07-04 04:33:08,137 - INFO - orders - [PERF] Order processing: 0.3732s
2025-07-04 04:33:08,138 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '2980621235', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_price': Decimal('0.52049204400000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('520.49'), 'margin': Decimal('6.553327704192869475355707066'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 04:33:08,139 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 2980621235
2025-07-04 04:33:08,170 - INFO - orders - [PERF] Order creation: 0.0325s
2025-07-04 04:33:08,170 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 04:33:08,171 - INFO - orders - Publishing order update for user 1
2025-07-04 04:33:08,173 - INFO - orders - Publishing user data update for user 1
2025-07-04 04:33:08,174 - INFO - orders - Publishing market data trigger
2025-07-04 04:33:08,177 - INFO - orders - [PERF] TOTAL place_order: 0.4195s
2025-07-04 04:33:08,213 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 1 open orders, 0 pending orders
2025-07-04 04:33:08,225 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 04:33:09,945 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCHF, Type: SELL
2025-07-04 04:33:10,262 - INFO - orders - [MARGIN_CALC] Market data for AUDCHF: {'b': '0.5204500000', 'o': '0.5203900000'}
2025-07-04 04:33:10,262 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCHF, using bid price with spread: bid=0.5204500000, ask=0.52050204500000
2025-07-04 04:33:10,262 - INFO - orders - [MARGIN_CALC] Using prices for AUDCHF: bid=0.5204500000, ask=0.52050204500000
2025-07-04 04:33:10,264 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.20 CHF to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 04:33:10,264 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-04 04:33:10,265 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:33:10,265 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-04 04:33:10,265 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-04 04:33:10,268 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7934900000'), 'o': Decimal('0.7934400000')}
2025-07-04 04:33:10,269 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7934900000
2025-07-04 04:33:10,269 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.20 CHF / 0.7934900000 = 6.553327704192869475355707066 USD
2025-07-04 04:33:10,269 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCHF, Type: SELL, Qty: 0.01, Price: 0.5204500000, Margin: 6.553327704192869475355707066, Commission: 0.10
2025-07-04 04:33:10,292 - INFO - orders - [PERF] Order processing: 0.3431s
2025-07-04 04:33:10,292 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '6453214522', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCHF', 'order_type': 'SELL', 'order_price': Decimal('0.5204500000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('520.45'), 'margin': Decimal('6.553327704192869475355707066'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 04:33:10,294 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 6453214522
2025-07-04 04:33:10,322 - INFO - orders - [PERF] Order creation: 0.0295s
2025-07-04 04:33:10,322 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 04:33:10,323 - INFO - orders - Publishing order update for user 1
2025-07-04 04:33:10,326 - INFO - orders - Publishing user data update for user 1
2025-07-04 04:33:10,331 - INFO - orders - Publishing market data trigger
2025-07-04 04:33:10,333 - INFO - orders - [PERF] TOTAL place_order: 0.3885s
2025-07-04 04:33:10,375 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 2 open orders, 0 pending orders
2025-07-04 04:33:10,386 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 04:33:13,451 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCHF, Type: BUY
2025-07-04 04:33:13,774 - INFO - orders - [MARGIN_CALC] Market data for AUDCHF: {'b': '0.5204600000', 'o': '0.5204000000'}
2025-07-04 04:33:13,774 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCHF, using bid price with spread: bid=0.5204600000, ask=0.52051204600000
2025-07-04 04:33:13,775 - INFO - orders - [MARGIN_CALC] Using prices for AUDCHF: bid=0.5204600000, ask=0.52051204600000
2025-07-04 04:33:13,777 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.21 CHF to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 04:33:13,778 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-04 04:33:13,781 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:33:13,781 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-04 04:33:13,781 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-04 04:33:13,783 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7935000000'), 'o': Decimal('0.7934700000')}
2025-07-04 04:33:13,783 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7935000000
2025-07-04 04:33:13,783 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.21 CHF / 0.7935000000 = 6.565847511027095148078134846 USD
2025-07-04 04:33:13,784 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCHF, Type: BUY, Qty: 0.01, Price: 0.52051204600000, Margin: 6.565847511027095148078134846, Commission: 0.10
2025-07-04 04:33:13,818 - INFO - orders - [PERF] Order processing: 0.3614s
2025-07-04 04:33:13,819 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '1630571282', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_price': Decimal('0.52051204600000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('520.51'), 'margin': Decimal('6.565847511027095148078134846'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 04:33:13,819 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 1630571282
2025-07-04 04:33:13,840 - INFO - orders - [PERF] Order creation: 0.0217s
2025-07-04 04:33:13,840 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 04:33:13,841 - INFO - orders - Publishing order update for user 1
2025-07-04 04:33:13,843 - INFO - orders - Publishing user data update for user 1
2025-07-04 04:33:13,846 - INFO - orders - Publishing market data trigger
2025-07-04 04:33:13,850 - INFO - orders - [PERF] TOTAL place_order: 0.3991s
2025-07-04 04:33:13,889 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 3 open orders, 0 pending orders
2025-07-04 04:33:13,894 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 04:33:23,328 - INFO - orders - Pending order placement request received - User ID: 1, Symbol: AUDCAD, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 04:33:23,332 - INFO - orders - Validating pending order price: Order type=BUY_LIMIT, Order price=0.88, Current buy price=0.8915000000, Current sell price=0.8914600000
2025-07-04 04:33:23,340 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 04:33:23,342 - INFO - orders - [DEBUG] User data from cache: {'wallet_balance': Decimal('24970.62000000'), 'leverage': Decimal('100.00'), 'group_name': 'Group B', 'margin': Decimal('13.13000000')}
2025-07-04 04:33:23,343 - INFO - orders - [DEBUG] Group name: Group B
2025-07-04 04:33:23,343 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 04:33:23,343 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 04:33:23,344 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 04:33:23,344 - INFO - orders - User 1 is_barclays_live_user: False (user_type: demo, sending_orders_normalized: barclays)
2025-07-04 04:33:23,346 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-07-04 04:33:23,348 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 04:33:23,351 - INFO - orders - Calculated initial margin: None, commission: None for pending order 9006414801
2025-07-04 04:33:23,358 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '9006414801', 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.88'), 'user_type': 'demo', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '6099240904', 'takeprofit_id': '6937172279', 'order_user_id': 1, 'order_status': 'PENDING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 04:33:23,359 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 1 at price 0.88
2025-07-04 04:33:23,359 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '9006414801', 'order_status': 'PENDING', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '6099240904', 'takeprofit_id': '6937172279', 'close_id': None}
2025-07-04 04:33:23,359 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '9006414801', 'order_status': 'PENDING', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '6099240904', 'takeprofit_id': '6937172279', 'close_id': None}
2025-07-04 04:33:23,359 - DEBUG - orders - [DEBUG][create_order] DemoUserOrder status length: 7
2025-07-04 04:33:23,359 - ERROR - orders - Unexpected error in place_order: 'status' must be a string of length 10-30 for demo orders.
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 816, in place_pending_order
    db_order = await crud_order.create_order(db, order_create_internal.model_dump(), order_model)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\app\crud\crud_order.py", line 43, in create_order
    raise ValueError("'status' must be a string of length 10-30 for demo orders.")
ValueError: 'status' must be a string of length 10-30 for demo orders.
2025-07-04 04:33:30,050 - INFO - orders - Pending order placement request received - User ID: 1, Symbol: AUDCAD, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 04:33:30,062 - INFO - orders - Validating pending order price: Order type=BUY_LIMIT, Order price=0.88, Current buy price=0.8914900000, Current sell price=0.8914600000
2025-07-04 04:33:30,071 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 04:33:30,073 - INFO - orders - [DEBUG] User data from cache: {'wallet_balance': Decimal('24970.62000000'), 'leverage': Decimal('100.00'), 'group_name': 'Group B', 'margin': Decimal('13.13000000')}
2025-07-04 04:33:30,073 - INFO - orders - [DEBUG] Group name: Group B
2025-07-04 04:33:30,075 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 04:33:30,075 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 04:33:30,075 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 04:33:30,075 - INFO - orders - User 1 is_barclays_live_user: False (user_type: demo, sending_orders_normalized: barclays)
2025-07-04 04:33:30,079 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-07-04 04:33:30,082 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 04:33:30,082 - INFO - orders - Calculated initial margin: None, commission: None for pending order 3738646758
2025-07-04 04:33:30,092 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '3738646758', 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.88'), 'user_type': 'demo', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '3403471007', 'takeprofit_id': '9315345875', 'order_user_id': 1, 'order_status': 'PENDING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 04:33:30,093 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 1 at price 0.88
2025-07-04 04:33:30,093 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '3738646758', 'order_status': 'PENDING', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '3403471007', 'takeprofit_id': '9315345875', 'close_id': None}
2025-07-04 04:33:30,094 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '3738646758', 'order_status': 'PENDING', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '3403471007', 'takeprofit_id': '9315345875', 'close_id': None}
2025-07-04 04:33:30,094 - DEBUG - orders - [DEBUG][create_order] DemoUserOrder status length: 7
2025-07-04 04:33:30,094 - ERROR - orders - Unexpected error in place_order: 'status' must be a string of length 10-30 for demo orders.
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 816, in place_pending_order
    db_order = await crud_order.create_order(db, order_create_internal.model_dump(), order_model)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\FASTAPI\app\crud\crud_order.py", line 43, in create_order
    raise ValueError("'status' must be a string of length 10-30 for demo orders.")
ValueError: 'status' must be a string of length 10-30 for demo orders.
2025-07-04 04:35:17,813 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 04:35:17,813 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 04:41:04,286 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 04:41:04,286 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 04:41:12,230 - INFO - orders - Pending order placement request received - User ID: 1, Symbol: AUDCAD, Type: BUY_LIMIT, Quantity: 0.01
2025-07-04 04:41:12,254 - INFO - orders - Validating pending order price: Order type=BUY_LIMIT, Order price=0.88, Current buy price=0.8914000000, Current sell price=0.8913900000
2025-07-04 04:41:12,278 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 04:41:12,281 - INFO - orders - [DEBUG] User data from cache: {'id': 1, 'email': 'dhanush777ss@gmail.com', 'account_number': '5O42G', 'group_name': 'Group B', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('24970.62000000'), 'margin': Decimal('13.13000000'), 'user_type': 'demo', 'first_name': None, 'last_name': None, 'country': None, 'phone_number': Decimal('8618025298')}
2025-07-04 04:41:12,281 - INFO - orders - [DEBUG] Group name: Group B
2025-07-04 04:41:12,282 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 04:41:12,283 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 04:41:12,283 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 04:41:12,283 - INFO - orders - User 1 is_barclays_live_user: False (user_type: demo, sending_orders_normalized: barclays)
2025-07-04 04:41:12,287 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-07-04 04:41:12,289 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 04:41:12,291 - INFO - orders - Calculated initial margin: None, commission: None for pending order 7862260538
2025-07-04 04:41:12,302 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '7862260538', 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.88'), 'user_type': 'demo', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '4895617823', 'takeprofit_id': '1019697214', 'order_user_id': 1, 'order_status': 'PENDING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 04:41:12,302 - INFO - orders - Placing PENDING order: BUY_LIMIT for user 1 at price 0.88
2025-07-04 04:41:12,302 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '7862260538', 'order_status': 'PENDING', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '4895617823', 'takeprofit_id': '1019697214', 'close_id': None}
2025-07-04 04:41:12,302 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '7862260538', 'order_status': 'PENDING', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY_LIMIT', 'order_price': Decimal('0.88'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '4895617823', 'takeprofit_id': '1019697214', 'close_id': None}
2025-07-04 04:41:12,303 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 7862260538
2025-07-04 04:41:12,393 - INFO - orders - Order 7862260538 verified in database on attempt 1 before adding to Redis.
2025-07-04 04:41:12,403 - INFO - orders - Pending order 7862260538 added to Redis for non-Barclays user or demo user.
2025-07-04 04:41:12,409 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 905, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 04:41:12,419 - INFO - orders - [PERF] TOTAL place_order: 0.1894s
2025-07-04 04:41:12,475 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 3 open orders, 1 pending orders
2025-07-04 04:41:12,485 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 04:41:21,849 - INFO - orders - Pending order placement request received - User ID: 1, Symbol: AUDCAD, Type: SELL_LIMIT, Quantity: 0.01
2025-07-04 04:41:21,868 - INFO - orders - Validating pending order price: Order type=SELL_LIMIT, Order price=0.9, Current buy price=0.8914400000, Current sell price=0.8914200000
2025-07-04 04:41:21,878 - INFO - orders - Calculated contract_value for pending order: 1000.0000000000 (contract_size: 100000.00000000 * quantity: 0.01)
2025-07-04 04:41:21,881 - INFO - orders - [DEBUG] User data from cache: {'id': 1, 'email': 'dhanush777ss@gmail.com', 'account_number': '5O42G', 'group_name': 'Group B', 'leverage': Decimal('100.00'), 'wallet_balance': Decimal('24970.62000000'), 'margin': Decimal('13.13000000'), 'user_type': 'demo', 'first_name': None, 'last_name': None, 'country': None, 'phone_number': Decimal('8618025298')}
2025-07-04 04:41:21,881 - INFO - orders - [DEBUG] Group name: Group B
2025-07-04 04:41:21,884 - INFO - orders - [DEBUG] Group settings from cache: {'sending_orders': 'barclays'}
2025-07-04 04:41:21,885 - INFO - orders - [DEBUG] sending_orders value: barclays, type: <class 'str'>
2025-07-04 04:41:21,885 - INFO - orders - [DEBUG] sending_orders_normalized: barclays
2025-07-04 04:41:21,885 - INFO - orders - User 1 is_barclays_live_user: False (user_type: demo, sending_orders_normalized: barclays)
2025-07-04 04:41:21,888 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-07-04 04:41:21,892 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 04:41:21,894 - INFO - orders - Calculated initial margin: None, commission: None for pending order 7298652445
2025-07-04 04:41:21,907 - INFO - orders - [DEBUG][pending_order] Prepared order_data_for_internal_processing: {'order_id': '7298652445', 'order_company_name': 'AUDCAD', 'order_type': 'SELL_LIMIT', 'order_quantity': Decimal('0.01'), 'order_price': Decimal('0.9'), 'user_type': 'demo', 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '4470874181', 'takeprofit_id': '1507172643', 'order_user_id': 1, 'order_status': 'PENDING', 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'open_time': None}
2025-07-04 04:41:21,908 - INFO - orders - Placing PENDING order: SELL_LIMIT for user 1 at price 0.9
2025-07-04 04:41:21,908 - INFO - orders - [ENTER-CRUD] create_order called with: {'order_id': '7298652445', 'order_status': 'PENDING', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'SELL_LIMIT', 'order_price': Decimal('0.9'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '4470874181', 'takeprofit_id': '1507172643', 'close_id': None}
2025-07-04 04:41:21,909 - DEBUG - orders - [DEBUG][create_order] Received order_data: {'order_id': '7298652445', 'order_status': 'PENDING', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'SELL_LIMIT', 'order_price': Decimal('0.9'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': None, 'commission': None, 'status': 'PENDING', 'stop_loss': Decimal('0'), 'take_profit': Decimal('0'), 'stoploss_id': '4470874181', 'takeprofit_id': '1507172643', 'close_id': None}
2025-07-04 04:41:21,909 - DEBUG - orders - [DEBUG][create_order] Created OrderActionHistory record for order_id: 7298652445
2025-07-04 04:41:21,952 - INFO - orders - Order 7298652445 verified in database on attempt 1 before adding to Redis.
2025-07-04 04:41:21,959 - INFO - orders - Pending order 7298652445 added to Redis for non-Barclays user or demo user.
2025-07-04 04:41:21,964 - ERROR - orders - Error updating user data cache after order placement: name 'user_id' is not defined
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 905, in place_pending_order
    await set_user_data_cache(redis_client, user_id, user_data_to_cache, user_type)
                                            ^^^^^^^
NameError: name 'user_id' is not defined
2025-07-04 04:41:21,974 - INFO - orders - [PERF] TOTAL place_order: 0.1259s
2025-07-04 04:41:22,004 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 3 open orders, 2 pending orders
2025-07-04 04:41:22,009 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 04:54:04,973 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 04:54:04,973 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 04:54:42,984 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-07-04 04:54:52,330 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCAD, Type: BUY
2025-07-04 04:54:52,679 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8912700000', 'o': '0.8912600000'}
2025-07-04 04:54:52,680 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8912700000, ask=0.89135912700000
2025-07-04 04:54:52,680 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8912700000, ask=0.89135912700000
2025-07-04 04:54:52,692 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.91 CAD to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 04:54:52,692 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 04:54:52,699 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:54:52,700 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 04:54:52,700 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 04:54:52,706 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3590000000'), 'o': Decimal('1.3589700000')}
2025-07-04 04:54:52,706 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3590000000
2025-07-04 04:54:52,706 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.91 CAD / 1.3590000000 = 6.556291390728476821192052980 USD
2025-07-04 04:54:52,706 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89135912700000, Margin: 6.556291390728476821192052980, Commission: 0.10
2025-07-04 04:54:52,802 - INFO - orders - [PERF] Order processing: 0.4681s
2025-07-04 04:54:52,803 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '8228618392', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89135912700000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.36'), 'margin': Decimal('6.556291390728476821192052980'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 04:54:52,804 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 8228618392
2025-07-04 04:54:52,855 - INFO - orders - [PERF] Order creation: 0.0523s
2025-07-04 04:54:52,855 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 04:54:52,855 - INFO - orders - Publishing order update for user 1
2025-07-04 04:54:52,859 - INFO - orders - Publishing user data update for user 1
2025-07-04 04:54:52,863 - INFO - orders - Publishing market data trigger
2025-07-04 04:54:52,868 - INFO - orders - [PERF] TOTAL place_order: 0.5420s
2025-07-04 04:54:52,907 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 4 open orders, 2 pending orders
2025-07-04 04:54:52,928 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 04:54:57,641 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCAD, Type: SELL
2025-07-04 04:54:57,994 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8912600000', 'o': '0.8912500000'}
2025-07-04 04:54:57,995 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8912600000, ask=0.89134912600000
2025-07-04 04:54:57,995 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8912600000, ask=0.89134912600000
2025-07-04 04:54:58,000 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.91 CAD to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 04:54:58,000 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 04:54:58,001 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:54:58,001 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 04:54:58,001 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 04:54:58,003 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3589900000'), 'o': Decimal('1.3589700000')}
2025-07-04 04:54:58,003 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3589900000
2025-07-04 04:54:58,003 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.91 CAD / 1.3589900000 = 6.556339634581564249920897137 USD
2025-07-04 04:54:58,004 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: SELL, Qty: 0.01, Price: 0.8912600000, Margin: 6.556339634581564249920897137, Commission: 0.10
2025-07-04 04:54:58,015 - INFO - orders - [PERF] Order processing: 0.3717s
2025-07-04 04:54:58,016 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '2949327211', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'SELL', 'order_price': Decimal('0.8912600000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.26'), 'margin': Decimal('6.556339634581564249920897137'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 04:54:58,016 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 2949327211
2025-07-04 04:54:58,033 - INFO - orders - [PERF] Order creation: 0.0177s
2025-07-04 04:54:58,033 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 04:54:58,034 - INFO - orders - Publishing order update for user 1
2025-07-04 04:54:58,035 - INFO - orders - Publishing user data update for user 1
2025-07-04 04:54:58,037 - INFO - orders - Publishing market data trigger
2025-07-04 04:54:58,039 - INFO - orders - [PERF] TOTAL place_order: 0.3978s
2025-07-04 04:54:58,107 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 5 open orders, 2 pending orders
2025-07-04 04:54:58,203 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 04:55:00,758 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCAD, Type: BUY
2025-07-04 04:55:01,070 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8913000000', 'o': '0.8912900000'}
2025-07-04 04:55:01,071 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8913000000, ask=0.89138913000000
2025-07-04 04:55:01,071 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8913000000, ask=0.89138913000000
2025-07-04 04:55:01,072 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.91 CAD to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 04:55:01,072 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 04:55:01,073 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:55:01,073 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 04:55:01,073 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 04:55:01,077 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3589900000'), 'o': Decimal('1.3589700000')}
2025-07-04 04:55:01,077 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3589900000
2025-07-04 04:55:01,077 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.91 CAD / 1.3589900000 = 6.556339634581564249920897137 USD
2025-07-04 04:55:01,077 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89138913000000, Margin: 6.556339634581564249920897137, Commission: 0.10
2025-07-04 04:55:01,107 - INFO - orders - [PERF] Order processing: 0.3461s
2025-07-04 04:55:01,108 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '8407182223', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89138913000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.39'), 'margin': Decimal('6.556339634581564249920897137'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 04:55:01,108 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 8407182223
2025-07-04 04:55:01,127 - INFO - orders - [PERF] Order creation: 0.0195s
2025-07-04 04:55:01,127 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 04:55:01,128 - INFO - orders - Publishing order update for user 1
2025-07-04 04:55:01,131 - INFO - orders - Publishing user data update for user 1
2025-07-04 04:55:01,135 - INFO - orders - Publishing market data trigger
2025-07-04 04:55:01,142 - INFO - orders - [PERF] TOTAL place_order: 0.3843s
2025-07-04 04:55:01,189 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 6 open orders, 2 pending orders
2025-07-04 04:55:01,198 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 04:55:11,932 - INFO - orders - Order close request received - Order ID: 8407182223, User ID: 1, Close Price: 0.89123
2025-07-04 04:55:11,932 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x000001FAA915CFC0>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 04:55:11,932 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-04 04:55:11,933 - INFO - orders - Request to close order 8407182223 for user 1 (user_type: demo) with price 0.89123. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 04:55:11,946 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-04 04:55:11,966 - INFO - orders - Existing entry commission for order 8407182223: 0.10000000
2025-07-04 04:55:11,967 - INFO - orders - Commission calculation for order 8407182223: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-04 04:55:11,967 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.159130000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 8407182223)
2025-07-04 04:55:11,967 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 04:55:11,968 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:55:11,969 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 04:55:11,969 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 04:55:11,970 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3590000000'), 'o': Decimal('1.3589700000')}
2025-07-04 04:55:11,970 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3590000000
2025-07-04 04:55:11,970 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.159130000000000000000000 CAD / 1.3590000000 = -0.1170934510669610007358351729 USD
2025-07-04 04:55:12,000 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24970.30000000, margin=19.69
2025-07-04 04:55:12,001 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24970.30000000, margin=19.69
2025-07-04 04:55:12,002 - INFO - orders - User data cache updated for user 1
2025-07-04 04:55:12,002 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-04 04:55:12,002 - INFO - orders - Using order model: DemoUserOrder
2025-07-04 04:55:12,012 - INFO - orders - Fetched 5 open orders for user 1
2025-07-04 04:55:12,017 - INFO - orders - Fetched 2 pending orders for user 1
2025-07-04 04:55:12,019 - INFO - orders - Updated static orders cache for user 1 with 5 open orders and 2 pending orders
2025-07-04 04:55:12,020 - INFO - orders - Publishing order update for user 1
2025-07-04 04:55:12,021 - INFO - orders - Publishing user data update for user 1
2025-07-04 04:55:12,023 - INFO - orders - Publishing market data trigger
2025-07-04 04:55:18,301 - INFO - orders - Order close request received - Order ID: 2949327211, User ID: 1, Close Price: 0.89129
2025-07-04 04:55:18,301 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x000001FAA915D220>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 04:55:18,302 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-04 04:55:18,302 - INFO - orders - Request to close order 2949327211 for user 1 (user_type: demo) with price 0.89129. Frontend provided type: SELL, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 04:55:18,314 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-04 04:55:18,329 - INFO - orders - Existing entry commission for order 2949327211: 0.10000000
2025-07-04 04:55:18,329 - INFO - orders - Commission calculation for order 2949327211: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-04 04:55:18,329 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.030000000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 2949327211)
2025-07-04 04:55:18,329 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 04:55:18,330 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:55:18,330 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 04:55:18,330 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 04:55:18,332 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3590000000'), 'o': Decimal('1.3589800000')}
2025-07-04 04:55:18,332 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3590000000
2025-07-04 04:55:18,332 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.030000000000000000000000 CAD / 1.3590000000 = -0.02207505518763796909492273731 USD
2025-07-04 04:55:18,361 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24970.08000000, margin=19.69
2025-07-04 04:55:18,361 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24970.08000000, margin=19.69
2025-07-04 04:55:18,363 - INFO - orders - User data cache updated for user 1
2025-07-04 04:55:18,363 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-04 04:55:18,364 - INFO - orders - Using order model: DemoUserOrder
2025-07-04 04:55:18,369 - INFO - orders - Fetched 4 open orders for user 1
2025-07-04 04:55:18,372 - INFO - orders - Fetched 2 pending orders for user 1
2025-07-04 04:55:18,375 - INFO - orders - Updated static orders cache for user 1 with 4 open orders and 2 pending orders
2025-07-04 04:55:18,375 - INFO - orders - Publishing order update for user 1
2025-07-04 04:55:18,378 - INFO - orders - Publishing user data update for user 1
2025-07-04 04:55:18,381 - INFO - orders - Publishing market data trigger
2025-07-04 04:55:20,424 - INFO - orders - Order close request received - Order ID: 8228618392, User ID: 1, Close Price: 0.89121
2025-07-04 04:55:20,425 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x000001FAA915C510>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 04:55:20,425 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-04 04:55:20,426 - INFO - orders - Request to close order 8228618392 for user 1 (user_type: demo) with price 0.89121. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 04:55:20,447 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-04 04:55:20,470 - INFO - orders - Existing entry commission for order 8228618392: 0.10000000
2025-07-04 04:55:20,470 - INFO - orders - Commission calculation for order 8228618392: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-04 04:55:20,470 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.149130000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 8228618392)
2025-07-04 04:55:20,470 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 04:55:20,472 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:55:20,472 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 04:55:20,472 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 04:55:20,474 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3590100000'), 'o': Decimal('1.3589800000')}
2025-07-04 04:55:20,474 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3590100000
2025-07-04 04:55:20,475 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.149130000000000000000000 CAD / 1.3590100000 = -0.1097342918742319776896417245 USD
2025-07-04 04:55:20,507 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24969.77000000, margin=13.13
2025-07-04 04:55:20,507 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24969.77000000, margin=13.13
2025-07-04 04:55:20,511 - INFO - orders - User data cache updated for user 1
2025-07-04 04:55:20,511 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-04 04:55:20,511 - INFO - orders - Using order model: DemoUserOrder
2025-07-04 04:55:20,517 - INFO - orders - Fetched 3 open orders for user 1
2025-07-04 04:55:20,521 - INFO - orders - Fetched 2 pending orders for user 1
2025-07-04 04:55:20,524 - INFO - orders - Updated static orders cache for user 1 with 3 open orders and 2 pending orders
2025-07-04 04:55:20,524 - INFO - orders - Publishing order update for user 1
2025-07-04 04:55:20,527 - INFO - orders - Publishing user data update for user 1
2025-07-04 04:55:20,530 - INFO - orders - Publishing market data trigger
2025-07-04 04:55:26,248 - INFO - orders - Order close request received - Order ID: 1630571282, User ID: 1, Close Price: 0.52037
2025-07-04 04:55:26,248 - INFO - orders - user_to_operate_on: <app.database.models.DemoUser object at 0x000001FAA915C2B0>, type: <class 'app.database.models.DemoUser'>, user_type: demo, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'city', 'country', 'created_at', 'demo_user_favorites', 'email', 'group_name', 'hashed_password', 'id', 'isActive', 'is_service_account', 'leverage', 'margin', 'metadata', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 04:55:26,248 - INFO - orders - Using order model: demo_user_orders for user 1 (user_type: demo)
2025-07-04 04:55:26,248 - INFO - orders - Request to close order 1630571282 for user 1 (user_type: demo) with price 0.52037. Frontend provided type: BUY, company: AUDCHF, status: CLOSED, frontend_status: CLOSED.
2025-07-04 04:55:26,258 - INFO - orders - Demo user 1 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-04 04:55:26,274 - INFO - orders - Existing entry commission for order 1630571282: 0.10000000
2025-07-04 04:55:26,274 - INFO - orders - Commission calculation for order 1630571282: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-04 04:55:26,274 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.142050000000000000000000 CHF to USD for PnL on Close (user_id: 1, position: 1630571282)
2025-07-04 04:55:26,274 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-04 04:55:26,275 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:55:26,275 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-04 04:55:26,275 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-04 04:55:26,276 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7938400000'), 'o': Decimal('0.7938000000')}
2025-07-04 04:55:26,276 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7938400000
2025-07-04 04:55:26,276 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.142050000000000000000000 CHF / 0.7938400000 = -0.1789403406227955255467096644 USD
2025-07-04 04:55:26,299 - INFO - orders - AFTER COMMIT: User 1 wallet_balance=24969.39000000, margin=6.55
2025-07-04 04:55:26,299 - INFO - orders - Setting user data cache for user 1 with wallet_balance=24969.39000000, margin=6.55
2025-07-04 04:55:26,301 - INFO - orders - User data cache updated for user 1
2025-07-04 04:55:26,301 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-07-04 04:55:26,301 - INFO - orders - Using order model: DemoUserOrder
2025-07-04 04:55:26,419 - INFO - orders - Fetched 2 open orders for user 1
2025-07-04 04:55:26,423 - INFO - orders - Fetched 2 pending orders for user 1
2025-07-04 04:55:26,427 - INFO - orders - Updated static orders cache for user 1 with 2 open orders and 2 pending orders
2025-07-04 04:55:26,427 - INFO - orders - Publishing order update for user 1
2025-07-04 04:55:26,429 - INFO - orders - Publishing user data update for user 1
2025-07-04 04:55:26,432 - INFO - orders - Publishing market data trigger
2025-07-04 04:55:36,795 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCAD, Type: BUY
2025-07-04 04:55:37,134 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8912600000', 'o': '0.8912500000'}
2025-07-04 04:55:37,134 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8912600000, ask=0.89134912600000
2025-07-04 04:55:37,135 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8912600000, ask=0.89134912600000
2025-07-04 04:55:37,136 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.91 CAD to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 04:55:37,137 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 04:55:37,138 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:55:37,139 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 04:55:37,139 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 04:55:37,142 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3590000000'), 'o': Decimal('1.3589800000')}
2025-07-04 04:55:37,142 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3590000000
2025-07-04 04:55:37,142 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.91 CAD / 1.3590000000 = 6.556291390728476821192052980 USD
2025-07-04 04:55:37,142 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89134912600000, Margin: 6.556291390728476821192052980, Commission: 0.10
2025-07-04 04:55:37,170 - INFO - orders - [PERF] Order processing: 0.3713s
2025-07-04 04:55:37,171 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '7567494254', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89134912600000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.35'), 'margin': Decimal('6.556291390728476821192052980'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 04:55:37,171 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 7567494254
2025-07-04 04:55:37,192 - INFO - orders - [PERF] Order creation: 0.0219s
2025-07-04 04:55:37,193 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 04:55:37,193 - INFO - orders - Publishing order update for user 1
2025-07-04 04:55:37,196 - INFO - orders - Publishing user data update for user 1
2025-07-04 04:55:37,197 - INFO - orders - Publishing market data trigger
2025-07-04 04:55:37,200 - INFO - orders - [PERF] TOTAL place_order: 0.4050s
2025-07-04 04:55:37,238 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 3 open orders, 2 pending orders
2025-07-04 04:55:37,257 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 04:56:01,752 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 04:56:08,631 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-04 04:56:08,951 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8913800000', 'o': '0.8913600000'}
2025-07-04 04:56:08,951 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8913800000, ask=0.89146913800000
2025-07-04 04:56:08,951 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8913800000, ask=0.89146913800000
2025-07-04 04:56:08,953 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.91 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 04:56:08,954 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 04:56:08,956 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:56:08,956 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 04:56:08,956 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 04:56:08,957 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3591200000'), 'o': Decimal('1.3591000000')}
2025-07-04 04:56:08,957 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3591200000
2025-07-04 04:56:08,957 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.91 CAD / 1.3591200000 = 6.555712519865795514744834893 USD
2025-07-04 04:56:08,957 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89146913800000, Margin: 6.555712519865795514744834893, Commission: 0.00
2025-07-04 04:56:08,959 - INFO - orders - [PERF] Order processing: 0.3231s
2025-07-04 04:56:08,959 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '1964818632', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89146913800000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.47'), 'margin': Decimal('6.555712519865795514744834893'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 04:56:08,960 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 1964818632
2025-07-04 04:56:08,999 - INFO - orders - [PERF] Order creation: 0.0401s
2025-07-04 04:56:09,000 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 04:56:09,000 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 04:56:09,000 - INFO - orders - Publishing order update for user 4
2025-07-04 04:56:09,002 - INFO - orders - Publishing user data update for user 4
2025-07-04 04:56:09,006 - INFO - orders - Publishing market data trigger
2025-07-04 04:56:09,007 - INFO - orders - [PERF] TOTAL place_order: 0.3766s
2025-07-04 04:56:09,037 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 04:56:09,045 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 04:56:09,047 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 04:56:09,051 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '1964818632', 'user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': 0.01, 'price': 0.891469138, 'status': 'OPEN', 'contract_value': 891.47}
2025-07-04 04:56:26,654 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: SELL
2025-07-04 04:56:27,006 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8913800000', 'o': '0.8913500000'}
2025-07-04 04:56:27,006 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8913800000, ask=0.89146913800000
2025-07-04 04:56:27,007 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8913800000, ask=0.89146913800000
2025-07-04 04:56:27,008 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.91 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 04:56:27,009 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 04:56:27,011 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 04:56:27,011 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 04:56:27,011 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 04:56:27,012 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3591700000'), 'o': Decimal('1.3591400000')}
2025-07-04 04:56:27,012 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3591700000
2025-07-04 04:56:27,013 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.91 CAD / 1.3591700000 = 6.555471353840947048566404497 USD
2025-07-04 04:56:27,013 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: SELL, Qty: 0.01, Price: 0.8913800000, Margin: 6.555471353840947048566404497, Commission: 0.00
2025-07-04 04:56:27,014 - INFO - orders - [PERF] Order processing: 0.3556s
2025-07-04 04:56:27,015 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '9048631985', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'SELL', 'order_price': Decimal('0.8913800000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('891.38'), 'margin': Decimal('6.555471353840947048566404497'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 04:56:27,016 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 9048631985
2025-07-04 04:56:27,035 - INFO - orders - [PERF] Order creation: 0.0206s
2025-07-04 04:56:27,036 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 04:56:27,036 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 04:56:27,037 - INFO - orders - Publishing order update for user 4
2025-07-04 04:56:27,039 - INFO - orders - Publishing user data update for user 4
2025-07-04 04:56:27,043 - INFO - orders - Publishing market data trigger
2025-07-04 04:56:27,046 - INFO - orders - [PERF] TOTAL place_order: 0.3924s
2025-07-04 04:56:27,093 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 04:56:27,110 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 04:56:27,156 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 04:56:27,162 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '9048631985', 'user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'SELL', 'order_quantity': 0.01, 'price': 0.89138, 'status': 'OPEN', 'contract_value': 891.38}
2025-07-04 05:02:05,323 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 05:02:05,323 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 05:02:26,626 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 05:09:34,892 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 05:09:34,893 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 05:10:07,060 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 05:10:07,060 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 05:10:28,902 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 05:10:46,692 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 05:11:43,614 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 05:12:12,163 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 05:12:49,141 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 05:13:35,251 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 05:13:48,745 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCHF, Type: BUY
2025-07-04 05:13:49,075 - INFO - orders - [MARGIN_CALC] Market data for AUDCHF: {'b': '0.5207000000', 'o': '0.5206300000'}
2025-07-04 05:13:49,075 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCHF, using bid price with spread: bid=0.5207000000, ask=0.52075207000000
2025-07-04 05:13:49,075 - INFO - orders - [MARGIN_CALC] Using prices for AUDCHF: bid=0.5207000000, ask=0.52075207000000
2025-07-04 05:13:49,079 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.21 CHF to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 05:13:49,079 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-07-04 05:13:49,080 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 05:13:49,081 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-07-04 05:13:49,081 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-07-04 05:13:49,082 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.7943000000'), 'o': Decimal('0.7942700000')}
2025-07-04 05:13:49,083 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.7943000000
2025-07-04 05:13:49,083 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.21 CHF / 0.7943000000 = 6.559234546141256452222082337 USD
2025-07-04 05:13:49,083 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCHF, Type: BUY, Qty: 0.01, Price: 0.52075207000000, Margin: 6.559234546141256452222082337, Commission: 0.10
2025-07-04 05:13:49,085 - INFO - orders - [PERF] Order processing: 0.3363s
2025-07-04 05:13:49,086 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '1628680719', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_price': Decimal('0.52075207000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('520.75'), 'margin': Decimal('6.559234546141256452222082337'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 05:13:49,087 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 1628680719
2025-07-04 05:13:49,128 - INFO - orders - [PERF] Order creation: 0.0427s
2025-07-04 05:13:49,129 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 05:13:49,129 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 05:13:49,129 - INFO - orders - Publishing order update for user 4
2025-07-04 05:13:49,132 - INFO - orders - Publishing user data update for user 4
2025-07-04 05:13:49,135 - INFO - orders - Publishing market data trigger
2025-07-04 05:13:49,142 - INFO - orders - [PERF] TOTAL place_order: 0.3986s
2025-07-04 05:13:49,172 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 05:13:49,183 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 05:13:49,187 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 05:13:49,193 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '1628680719', 'user_id': 4, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_quantity': 0.01, 'price': 0.52075207, 'status': 'OPEN', 'contract_value': 520.75}
2025-07-04 05:14:43,605 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 05:35:34,863 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 05:35:34,864 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 05:36:21,087 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 05:36:27,587 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-04 05:36:27,929 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8908300000', 'o': '0.8907900000'}
2025-07-04 05:36:27,930 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8908300000, ask=0.89091908300000
2025-07-04 05:36:27,930 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8908300000, ask=0.89091908300000
2025-07-04 05:36:27,934 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.91 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 05:36:27,934 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 05:36:27,936 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 05:36:27,937 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 05:36:27,937 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 05:36:27,940 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3593700000'), 'o': Decimal('1.3593200000')}
2025-07-04 05:36:27,940 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3593700000
2025-07-04 05:36:27,940 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.91 CAD / 1.3593700000 = 6.554506867151695270603294173 USD
2025-07-04 05:36:27,940 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89091908300000, Margin: 6.554506867151695270603294173, Commission: 0.00
2025-07-04 05:36:27,943 - INFO - orders - [PERF] Order processing: 0.3503s
2025-07-04 05:36:27,944 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '8911559289', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89091908300000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.00'), 'margin': Decimal('6.554506867151695270603294173'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 05:36:27,946 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 8911559289
2025-07-04 05:36:28,004 - INFO - orders - [PERF] Order creation: 0.0605s
2025-07-04 05:36:28,005 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 05:36:28,005 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 05:36:28,006 - INFO - orders - Publishing order update for user 4
2025-07-04 05:36:28,010 - INFO - orders - Publishing user data update for user 4
2025-07-04 05:36:28,014 - INFO - orders - Publishing market data trigger
2025-07-04 05:36:28,018 - INFO - orders - [PERF] TOTAL place_order: 0.4315s
2025-07-04 05:36:28,049 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 05:36:28,061 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 05:36:28,066 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 05:36:28,080 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '8911559289', 'user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': 0.01, 'price': 0.890919083, 'status': 'OPEN', 'contract_value': 1000.0}
2025-07-04 05:38:51,353 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 05:38:51,354 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 05:39:24,356 - INFO - orders - Service provider status request received for ID: 8911559289
2025-07-04 05:39:24,361 - INFO - orders - Found order 8911559289 with status: 'None' and order_status: 'PROCESSING'
2025-07-04 05:40:12,121 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 05:40:12,121 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 05:41:49,273 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 05:41:49,273 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 05:42:01,118 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-04 05:42:01,564 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8908500000', 'o': '0.8908000000'}
2025-07-04 05:42:01,564 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8908500000, ask=0.89093908500000
2025-07-04 05:42:01,564 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8908500000, ask=0.89093908500000
2025-07-04 05:42:01,566 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.91 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 05:42:01,566 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 05:42:01,569 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 05:42:01,570 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 05:42:01,570 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 05:42:01,571 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3593300000'), 'o': Decimal('1.3593100000')}
2025-07-04 05:42:01,572 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3593300000
2025-07-04 05:42:01,572 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.91 CAD / 1.3593300000 = 6.554699741784555626669020768 USD
2025-07-04 05:42:01,572 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89093908500000, Margin: 6.554699741784555626669020768, Commission: 0.00
2025-07-04 05:42:01,576 - INFO - orders - [PERF] Order processing: 0.4489s
2025-07-04 05:42:01,577 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '6452163825', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89093908500000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.00'), 'margin': Decimal('6.554699741784555626669020768'), 'commission': Decimal('0.00'), 'status': 'OPEN', 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 05:42:01,578 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 6452163825
2025-07-04 05:42:01,637 - INFO - orders - [PERF] Order creation: 0.0601s
2025-07-04 05:42:01,637 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 05:42:01,638 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 05:42:01,638 - INFO - orders - Publishing order update for user 4
2025-07-04 05:42:01,641 - INFO - orders - Publishing user data update for user 4
2025-07-04 05:42:01,647 - INFO - orders - Publishing market data trigger
2025-07-04 05:42:01,651 - INFO - orders - [PERF] TOTAL place_order: 0.5346s
2025-07-04 05:42:01,705 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 05:42:01,731 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 05:42:01,740 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 05:42:01,745 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '6452163825', 'user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': 0.01, 'price': 0.890939085, 'status': 'OPEN', 'contract_value': 1000.0}
2025-07-04 05:42:33,720 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 05:42:41,759 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-04 05:42:42,078 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8908400000', 'o': '0.8907900000'}
2025-07-04 05:42:42,078 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8908400000, ask=0.89092908400000
2025-07-04 05:42:42,078 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8908400000, ask=0.89092908400000
2025-07-04 05:42:42,088 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.91 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 05:42:42,088 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 05:42:42,095 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 05:42:42,095 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 05:42:42,095 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 05:42:42,103 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3592500000'), 'o': Decimal('1.3592300000')}
2025-07-04 05:42:42,103 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3592500000
2025-07-04 05:42:42,103 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.91 CAD / 1.3592500000 = 6.555085525105756851204708479 USD
2025-07-04 05:42:42,103 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89092908400000, Margin: 6.555085525105756851204708479, Commission: 0.00
2025-07-04 05:42:42,108 - INFO - orders - [PERF] Order processing: 0.3463s
2025-07-04 05:42:42,108 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '7025429314', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89092908400000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.00'), 'margin': Decimal('6.555085525105756851204708479'), 'commission': Decimal('0.00'), 'status': 'OPEN', 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 05:42:42,109 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 7025429314
2025-07-04 05:42:42,198 - INFO - orders - [PERF] Order creation: 0.0896s
2025-07-04 05:42:42,198 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 05:42:42,199 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 05:42:42,199 - INFO - orders - Publishing order update for user 4
2025-07-04 05:42:42,205 - INFO - orders - Publishing user data update for user 4
2025-07-04 05:42:42,210 - INFO - orders - Publishing market data trigger
2025-07-04 05:42:42,217 - INFO - orders - [PERF] TOTAL place_order: 0.4589s
2025-07-04 05:42:42,263 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 05:42:42,273 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 05:42:42,280 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 05:42:42,286 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '7025429314', 'user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': 0.01, 'price': 0.890929084, 'status': 'OPEN', 'contract_value': 1000.0}
2025-07-04 05:43:01,688 - INFO - orders - Service provider status request received for ID: 8911559289
2025-07-04 05:43:01,698 - INFO - orders - Found order 8911559289 with status: 'None' and order_status: 'PROCESSING'
2025-07-04 05:43:15,772 - INFO - orders - Service provider status request received for ID: 7025429314
2025-07-04 05:43:15,777 - INFO - orders - Found order 7025429314 with status: 'OPEN' and order_status: 'PROCESSING'
2025-07-04 05:43:52,772 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 05:43:52,772 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 05:43:56,396 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: SELL
2025-07-04 05:43:56,692 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8908300000', 'o': '0.8908000000'}
2025-07-04 05:43:56,692 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8908300000, ask=0.89091908300000
2025-07-04 05:43:56,692 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8908300000, ask=0.89091908300000
2025-07-04 05:43:56,693 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.91 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 05:43:56,693 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 05:43:56,694 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 05:43:56,694 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 05:43:56,694 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 05:43:56,695 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3592700000'), 'o': Decimal('1.3592600000')}
2025-07-04 05:43:56,695 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3592700000
2025-07-04 05:43:56,695 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.91 CAD / 1.3592700000 = 6.554989075018208302986161690 USD
2025-07-04 05:43:56,695 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: SELL, Qty: 0.01, Price: 0.8908300000, Margin: 6.554989075018208302986161690, Commission: 0.00
2025-07-04 05:43:56,696 - INFO - orders - [PERF] Order processing: 0.2977s
2025-07-04 05:43:56,697 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '4961413877', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'SELL', 'order_price': Decimal('0.8908300000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.00'), 'margin': Decimal('6.554989075018208302986161690'), 'commission': Decimal('0.00'), 'status': 'OPEN', 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 05:43:56,698 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 4961413877
2025-07-04 05:43:56,725 - INFO - orders - [PERF] Order creation: 0.0290s
2025-07-04 05:43:56,726 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 05:43:56,726 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 05:43:56,726 - INFO - orders - Publishing order update for user 4
2025-07-04 05:43:56,727 - INFO - orders - Publishing user data update for user 4
2025-07-04 05:43:56,728 - INFO - orders - Publishing market data trigger
2025-07-04 05:43:56,729 - INFO - orders - [PERF] TOTAL place_order: 0.3334s
2025-07-04 05:43:56,748 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 05:43:56,750 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 05:43:56,751 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 05:43:56,753 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '4961413877', 'user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'SELL', 'order_quantity': 0.01, 'price': 0.89083, 'status': 'OPEN', 'contract_value': 1000.0}
2025-07-04 05:45:35,838 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 05:45:35,838 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 05:45:42,387 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 05:45:42,387 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 05:58:29,490 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 05:58:29,490 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 05:59:47,091 - INFO - orders - Half-spread calculation request for order_id: 9048631985, symbol: AUDJPY
2025-07-04 06:21:15,799 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 06:21:15,800 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 06:21:32,909 - INFO - orders - Order close request received - Order ID: 9836469641, User ID: 4, Close Price: 0.89097
2025-07-04 06:21:32,910 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x0000018F595165D0>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-04 06:21:32,910 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-04 06:21:32,910 - INFO - orders - Request to close order 9836469641 for user 4 (user_type: live) with price 0.89097. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-04 06:21:32,916 - INFO - orders - User group: Standard, sending_orders setting: barclays
2025-07-04 06:21:32,916 - INFO - orders - Live user 4 from group 'Standard' has 'sending_orders' set to 'barclays'. Pushing close request to Firebase and skipping local DB update.
2025-07-04 06:21:32,921 - INFO - orders - [FIREBASE_CLOSE_REQUEST] Preparing to send payload for user-initiated close: {'order_id': '9836469641', 'close_price': '0.89097', 'user_id': 4, 'order_type': 'BUY', 'order_company_name': 'AUDCAD', 'order_quantity': '0.01000000', 'contract_value': '891.40000000', 'order_status': 'CLOSED', 'status': 'CLOSED', 'action': 'close_order', 'close_id': '1105305705'}
2025-07-04 06:27:59,200 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 06:27:59,200 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 06:28:22,655 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-07-04 06:28:33,736 - INFO - orders - Order placement request received - User: 1, Symbol: AUDCAD, Type: BUY
2025-07-04 06:28:34,047 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8914300000', 'o': '0.8913900000'}
2025-07-04 06:28:34,047 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8914300000, ask=0.89151914300000
2025-07-04 06:28:34,047 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8914300000, ask=0.89151914300000
2025-07-04 06:28:34,050 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 1, position: None)
2025-07-04 06:28:34,051 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 06:28:34,052 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 06:28:34,052 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 06:28:34,052 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 06:28:34,056 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3609100000'), 'o': Decimal('1.3608500000')}
2025-07-04 06:28:34,056 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3609100000
2025-07-04 06:28:34,056 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3609100000 = 6.554437839386880837086949174 USD
2025-07-04 06:28:34,056 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89151914300000, Margin: 6.554437839386880837086949174, Commission: 0.10
2025-07-04 06:28:34,096 - INFO - orders - [PERF] Order processing: 0.3575s
2025-07-04 06:28:34,096 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '5255051389', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89151914300000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.00'), 'margin': Decimal('6.554437839386880837086949174'), 'commission': Decimal('0.10'), 'status': 'OPEN', 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 06:28:34,097 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 5255051389
2025-07-04 06:28:34,181 - INFO - orders - [PERF] Order creation: 0.0847s
2025-07-04 06:28:34,181 - INFO - orders - is_barclays_live_user in place_order: False
2025-07-04 06:28:34,182 - INFO - orders - Publishing order update for user 1
2025-07-04 06:28:34,185 - INFO - orders - Publishing user data update for user 1
2025-07-04 06:28:34,187 - INFO - orders - Publishing market data trigger
2025-07-04 06:28:34,190 - INFO - orders - [PERF] TOTAL place_order: 0.4543s
2025-07-04 06:28:34,228 - app.api.v1.endpoints.orders - INFO - User 1: Updated static orders cache after order change - 4 open orders, 2 pending orders
2025-07-04 06:28:34,232 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 06:31:30,551 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 06:31:30,551 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 06:31:54,159 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-04 06:31:58,683 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-04 06:31:59,047 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8914600000', 'o': '0.8914300000'}
2025-07-04 06:31:59,047 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8914600000, ask=0.89154914600000
2025-07-04 06:31:59,047 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8914600000, ask=0.89154914600000
2025-07-04 06:31:59,049 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 06:31:59,049 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-04 06:31:59,050 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 06:31:59,050 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-04 06:31:59,050 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-04 06:31:59,051 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3606600000'), 'o': Decimal('1.3606400000')}
2025-07-04 06:31:59,051 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3606600000
2025-07-04 06:31:59,051 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3606600000 = 6.555642114856025752208487058 USD
2025-07-04 06:31:59,051 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89154914600000, Margin: 6.555642114856025752208487058, Commission: 0.00
2025-07-04 06:31:59,052 - INFO - orders - [PERF] Order processing: 0.3630s
2025-07-04 06:31:59,053 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '4379851186', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89154914600000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.00'), 'margin': Decimal('6.555642114856025752208487058'), 'commission': Decimal('0.00'), 'status': 'OPEN', 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 06:31:59,054 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 4379851186
2025-07-04 06:31:59,077 - INFO - orders - [PERF] Order creation: 0.0239s
2025-07-04 06:31:59,077 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 06:31:59,077 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 06:31:59,077 - INFO - orders - Publishing order update for user 4
2025-07-04 06:31:59,078 - INFO - orders - Publishing user data update for user 4
2025-07-04 06:31:59,080 - INFO - orders - Publishing market data trigger
2025-07-04 06:31:59,081 - INFO - orders - [PERF] TOTAL place_order: 0.3987s
2025-07-04 06:31:59,111 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 06:31:59,120 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 06:31:59,123 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 06:31:59,149 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '4379851186', 'user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_quantity': 0.01, 'price': 0.891549146, 'status': 'OPEN', 'contract_value': 1000.0}
2025-07-04 06:43:04,997 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 06:43:04,997 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 06:43:11,253 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: BUY
2025-07-04 06:43:11,574 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.6750000000', 'o': '94.6690000000'}
2025-07-04 06:43:11,575 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.6750000000, ask=94.68446750000000
2025-07-04 06:43:11,575 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.6750000000, ask=94.68446750000000
2025-07-04 06:43:11,577 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 946.84 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 06:43:11,578 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-04 06:43:11,579 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 06:43:11,579 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-04 06:43:11,579 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-04 06:43:11,580 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.4460000000'), 'o': Decimal('144.4410000000')}
2025-07-04 06:43:11,580 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.4460000000
2025-07-04 06:43:11,580 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 946.84 JPY / 144.4460000000 = 6.554975561801642136161610567 USD
2025-07-04 06:43:11,580 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 94.68446750000000, Margin: 6.554975561801642136161610567, Commission: 0.10
2025-07-04 06:43:11,584 - INFO - orders - [PERF] Order processing: 0.3161s
2025-07-04 06:43:11,584 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '5320207948', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_price': Decimal('94.68446750000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.00'), 'margin': Decimal('6.554975561801642136161610567'), 'commission': Decimal('0.10'), 'status': 'OPEN', 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 06:43:11,584 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 5320207948
2025-07-04 06:43:11,622 - INFO - orders - [PERF] Order creation: 0.0384s
2025-07-04 06:43:11,622 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 06:43:11,622 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 06:43:11,623 - INFO - orders - Publishing order update for user 4
2025-07-04 06:43:11,624 - INFO - orders - Publishing user data update for user 4
2025-07-04 06:43:11,626 - INFO - orders - Publishing market data trigger
2025-07-04 06:43:11,628 - INFO - orders - [PERF] TOTAL place_order: 0.3753s
2025-07-04 06:43:11,782 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-04 06:43:11,789 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 06:43:11,792 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 06:43:11,797 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '5320207948', 'user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': 0.01, 'price': 94.6844675, 'status': 'OPEN', 'contract_value': 1000.0}
2025-07-04 06:45:32,444 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 06:45:32,445 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 06:46:37,305 - INFO - orders - Order 5320207948 transitioning to OPEN. Calculating margin.
2025-07-04 06:46:37,305 - INFO - orders - Using fixed UserOrder model for Barclays service provider integration
2025-07-04 06:46:37,307 - INFO - orders - Using group_name: Standard for order 5320207948
2025-07-04 06:46:37,340 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDJPY: contract_size=100000.00000000, profit_currency=JPY, digit=3.00000
2025-07-04 06:46:37,341 - INFO - orders - Using user's leverage from cache: 100.00
2025-07-04 06:46:37,341 - ERROR - orders - [MARGIN_CALC] Error in calculate_single_order_margin: argument of type 'coroutine' is not iterable
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\margin_calculator.py", line 121, in calculate_single_order_margin
    if not raw_market_data or symbol not in raw_market_data:
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: argument of type 'coroutine' is not iterable
2025-07-04 06:46:37,344 - ERROR - orders - Failed to calculate margin or contract_value, using fallback calculation
2025-07-04 06:46:37,345 - INFO - orders - Fallback margin calculation: (100000.00000000 * 0.01 * 95.1) / 100.00 = 951.000000000
2025-07-04 06:46:37,345 - INFO - orders - New margin calculated: 951.000000000, contract_value: 1000.0000000000
2025-07-04 06:46:37,345 - INFO - orders - Recalculating total hedged margin for user 4 on symbol AUDJPY
2025-07-04 06:46:37,355 - INFO - orders - Found 0 existing open positions for this symbol
2025-07-04 06:46:37,355 - INFO - orders - Old total margin for AUDJPY: 0.0
2025-07-04 06:46:37,355 - INFO - orders - New total margin for AUDJPY: 951.00
2025-07-04 06:46:37,355 - INFO - orders - Margin change for user 4: 951.00
2025-07-04 06:46:37,363 - INFO - orders - User 4 margin updated from 26.22000000 to 977.22000000
2025-07-04 06:46:37,424 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-04 06:46:37,424 - INFO - orders - Using order model: UserOrder
2025-07-04 06:46:37,428 - INFO - orders - Fetched 7 open orders for user 4
2025-07-04 06:46:37,432 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-04 06:46:37,433 - INFO - orders - Updated static orders cache for user 4 with 7 open orders and 0 pending orders
2025-07-04 06:50:31,960 - INFO - orders - Application starting up - Orders logging initialized
2025-07-04 06:50:31,960 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-04 06:50:38,237 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: BUY
2025-07-04 06:50:38,653 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.6300000000', 'o': '94.6230000000'}
2025-07-04 06:50:38,654 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.6300000000, ask=94.63946300000000
2025-07-04 06:50:38,654 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.6300000000, ask=94.63946300000000
2025-07-04 06:50:38,655 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 946.39 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 06:50:38,655 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-04 06:50:38,656 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 06:50:38,656 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-04 06:50:38,656 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-04 06:50:38,657 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.4860000000'), 'o': Decimal('144.4790000000')}
2025-07-04 06:50:38,658 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.4860000000
2025-07-04 06:50:38,658 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 946.39 JPY / 144.4860000000 = 6.550046371274725578948825492 USD
2025-07-04 06:50:38,658 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 94.63946300000000, Margin: 6.550046371274725578948825492, Commission: 0.10
2025-07-04 06:50:38,659 - INFO - orders - [PERF] Order processing: 0.4208s
2025-07-04 06:50:38,660 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '1621588803', 'order_status': 'PROCESSING', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_price': Decimal('94.63946300000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.00'), 'margin': Decimal('6.550046371274725578948825492'), 'commission': Decimal('0.10'), 'status': 'OPEN', 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-04 06:50:38,661 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 1621588803
2025-07-04 06:50:38,692 - INFO - orders - [PERF] Order creation: 0.0332s
2025-07-04 06:50:38,692 - INFO - orders - is_barclays_live_user in place_order: True
2025-07-04 06:50:38,693 - INFO - orders - [BARCLAYS] Scheduling barclays_push in place_order
2025-07-04 06:50:38,693 - INFO - orders - Publishing order update for user 4
2025-07-04 06:50:38,694 - INFO - orders - Publishing user data update for user 4
2025-07-04 06:50:38,694 - INFO - orders - Publishing market data trigger
2025-07-04 06:50:38,695 - INFO - orders - [PERF] TOTAL place_order: 0.4615s
2025-07-04 06:50:38,711 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 7 open orders, 0 pending orders
2025-07-04 06:50:38,714 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-04 06:50:38,714 - INFO - orders - [BARCLAYS] barclays_push called in place_order
2025-07-04 06:50:38,715 - DEBUG - orders - [BARCLAYS] Calling send_order_to_firebase with data: {'order_id': '1621588803', 'user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_quantity': 0.01, 'price': 94.639463, 'status': 'OPEN', 'contract_value': 1000.0}
2025-07-04 06:51:05,704 - INFO - orders - Order 1621588803 transitioning to OPEN. Calculating margin.
2025-07-04 06:51:05,705 - INFO - orders - Using fixed UserOrder model for Barclays service provider integration
2025-07-04 06:51:05,706 - INFO - orders - Using group_name: Standard for order 1621588803
2025-07-04 06:51:06,065 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDJPY: contract_size=100000.00000000, profit_currency=JPY, digit=3.00000
2025-07-04 06:51:06,065 - INFO - orders - Using user's leverage from cache: 100.00
2025-07-04 06:51:06,065 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.6240000000', 'o': '94.6210000000'}
2025-07-04 06:51:06,066 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.6240000000, ask=94.63346240000000
2025-07-04 06:51:06,066 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.6240000000, ask=94.63346240000000
2025-07-04 06:51:06,068 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 946.33 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-04 06:51:06,069 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-04 06:51:06,071 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-04 06:51:06,072 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-04 06:51:06,072 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-04 06:51:06,075 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.4550000000'), 'o': Decimal('144.4530000000')}
2025-07-04 06:51:06,075 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.4550000000
2025-07-04 06:51:06,075 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 946.33 JPY / 144.4550000000 = 6.551036655013672077809698522 USD
2025-07-04 06:51:06,075 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 94.63346240000000, Margin: 6.551036655013672077809698522, Commission: 0.10
2025-07-04 06:51:06,076 - INFO - orders - New margin calculated: 6.551036655013672077809698522, contract_value: 1000.00
2025-07-04 06:51:06,076 - INFO - orders - [MARGIN] Final stored margin (USD): 6.551036655013672077809698522
2025-07-04 06:51:06,076 - INFO - orders - Recalculating total hedged margin for user 4 on symbol AUDJPY
2025-07-04 06:51:06,083 - INFO - orders - Found 1 existing open positions for this symbol
2025-07-04 06:51:06,084 - INFO - orders - Old total margin for AUDJPY: 951.00
2025-07-04 06:51:06,085 - INFO - orders - New total margin for AUDJPY: 1902.00
2025-07-04 06:51:06,086 - INFO - orders - Margin change for user 4: 951.00
2025-07-04 06:51:06,096 - INFO - orders - User 4 margin updated from 977.22000000 to 1928.22000000
2025-07-04 06:51:06,179 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-04 06:51:06,179 - INFO - orders - Using order model: UserOrder
2025-07-04 06:51:06,189 - INFO - orders - Fetched 8 open orders for user 4
2025-07-04 06:51:06,194 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-04 06:51:06,197 - INFO - orders - Updated static orders cache for user 4 with 8 open orders and 0 pending orders
